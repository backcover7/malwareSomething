Malware Analysis Lab Building

Virtual Box
	Network
		Adpater 1
			Attached to: Internal Network
			Name: Malware-Analysis-Network

	Sniffer
		OS
			Ubuntu (Version: 16.x, 64-bit, Minimal Desktop Installation.)       // Version 14.x will meet error when installing INetSim.
				sudo apt update
				sudo apt upgrade
		Network
			vim /etc/network/interfaces
				auto enp0s3
				iface enp0s3 inet static
				 address 10.0.0.1
				 netmask 255.255.255.0
			sudo ifup enp0s3
			sudo service networking restart

		INetSim
			sudo su
			echo "deb http://www.inetsim.org/debian/ binary/" > /etc/apt/sources.list.d/inetsim.list
			wget -O - http://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add -
			apt update
			apt install inetsim
			vim /etc/inetsim/inetsim.conf
				service_bind_address    0.0.0.0
				dns_default_ip    10.0.0.1
				https_bind_port 8443
			sudo systemctl disable systemd-resolved.service
			sudo service systemd-resolved stop
			sudo inetsim

		Burp
			https://portswigger.net/burp/communitydownload
			bash burpsuite_community_linux.sh
			sudo ./burpsuite_community_linux									// start via root cause regular user could not listen on 443 which is below 1024.
			Proxy
				Options
					Proxy Listeners
						# Create a new entry
						Binding
							Bind to port: 443
							Bind to address: All interfaces
						Request handling
							Redirect to host: localhost
							Redirect to port: 8443
							Support invisible proxying (enable only if needed)

	Victim
		OS
			Windows (Version: xp, 32-bit)										// Some of the malware could only run under 32-bit. You can build another Victim machine in 64-bit
		
		Network
			TCP/IPv4
				IP address:		10.0.0.2
				Subnet mask:		255.255.255.0
				Default gateway:	10.0.0.1
				Preferred DNS server:	10.0.0.1
			
			Internet Explorer
				http://10.0.0.1:8080/
				Download CA Certificate
				Install Certificate > Next >Place all certificates in the following store: Trusted Root Certificate Authorities > Next > Finish > OK > OK

			Windbg debug env
				Ctrl+R > c:\boot.ini > add the following line in the end
				multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Windows XP Debug" /noexecute=optin /fastdetect /debug /debugport=COM1 /baudrate=115200
				
				- Power off

				Virtual Box > Settings > Serial Port > Port1 
					Enable Serial Port
						Port Mode: Host Pipe
						Path/Address: \\.\pipe\Debug
						[x] Connect to existing pipe/socket

				- Start vm
				
				Windbg > File > Attack to Kernel > COM
					port: \\.\pipe\Debug
					[x] Initial break

# Reference
	https://www.freebuf.com/articles/system/177601.html
