Lab07_01.exe
    PE Analysis
        # Virustotal
            41/72
            SHA-256: 0c98769e42b364711c478226ef199bfbba90db80175eb1b8cd565aa694c09852

        # PEid
            Microsoft Visual C++ 6.0

        # PEview
            TimeStamp (IMAGE_FILE_HEADER): 2011/09/30 Fri 19:49:12 UTC
            Subsystem (IMAGE_OPTIONAL_HEADER): IMAGE_SUBSYSTEM_WINDOWS_CUI (cmd)
            Sections (Virtual Size / Size of Raw Data) -> No Packed
                .text: 295E/1000
                .rdata: 8CA/1000
                .data: 7FC/1000
        
        # Dependency Walker
            KERNEL32.DLL
                CreateMutexA
                CreateThread
                CreateWaitableTimerA
                ExitProcess
                FreeEnvironmentStringsA
                FreeEnvironmentStringsW
                GetACP
                GetCPInfo
                GetCommandLineA
                GetCurrentProcess
                GetEnvironmentStrings
                GetEnvironmentStringsW
                GetFileType
                GetModuleFileNameA
                GetOEMCP
                GetProcAddress
                GetStartupInfoA
                GetStdHandle
                GetStringTypeA
                GetStringTypeW
                GetVersion
                HeapAlloc
                HeapCreate
                HeapDestroy
                HeapFree
                HeapReAlloc
                LCMapStringA
                LCMapStringW
                LoadLibraryA
                MultiByteToWideChar
                OpenMutexA
                RtlUnwind
                SetHandleCount
                SetWaitableTimer
                Sleep
                SystemTimeToFileTime
                TerminateProcess
                UnhandledExceptionFilter
                VirtualAlloc
                VirtualFree
                WaitForSingleObject
                WideCharToMultiByte
                WriteFile
            ADVAPI32.DLL
                CreateServiceA
                OpenSCManagerA
                StartServiceCtrlDispatcherA
            WININET.DLL
                InternetOpenA
                InternetOpenUrlA

        # strings.exe (Only part of the results)
            MalService
            Malservice
            HGL345
            http://www.malwareanalysisbook.com
            Internet Explorer 8.0

    Dynamic Analysis
        C:\Documents and Settings\practice\Desktop>Lab07-01.exe
        _
        C:\Documents and Settings\practice>net start Malservice
        The Malservice service is starting........
        The Malservice service could not be started.

        More help is available by typing NET HELPMSG 3523.

        # RegShot (Part of results)
            ----------------------------------
            Keys added:4
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\Malservice
            HKLM\SYSTEM\ControlSet001\Services\Malservice\Security
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\Security

            ----------------------------------
            Values added:14
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\Malservice\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\ControlSet001\Services\Malservice\Type: 0x00000010
            HKLM\SYSTEM\ControlSet001\Services\Malservice\Start: 0x00000002
            HKLM\SYSTEM\ControlSet001\Services\Malservice\ErrorControl: 0x00000000
            HKLM\SYSTEM\ControlSet001\Services\Malservice\ImagePath: "C:\Documents and Settings\practice\Desktop\Lab07_01.exe"
            HKLM\SYSTEM\ControlSet001\Services\Malservice\DisplayName: "Malservice"
            HKLM\SYSTEM\ControlSet001\Services\Malservice\ObjectName: "LocalSystem"
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\Type: 0x00000010
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\Start: 0x00000002
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\ErrorControl: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\ImagePath: "C:\Documents and Settings\practice\Desktop\Lab07_01.exe"
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\DisplayName: "Malservice"
            HKLM\SYSTEM\CurrentControlSet\Services\Malservice\ObjectName: "LocalSystem"

            ----------------------------------
            Values modified:2
            ----------------------------------
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 63 39 12 21 25 91 19 CA C2 03 FA 09 E8 18 3F 9A DD F3 8A 34 46 9C D5 D3 00 0A 3C 1C 4E 94 01 30 34 DC B7 BA AC EF 36 D4 15 0B E3 2B D4 F2 23 FF 86 2E B7 5E 90 71 51 FC B5 EF AC 7A 4B C0 79 95 01 10 FA 20 16 57 FF A3 BC 82 C4 52 AB CF ED 16
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 4D 44 C9 26 C7 5E B9 FF BF FF 7C 30 1B BA 1D D7 82 64 14 07 15 A1 CC C5 A8 E7 BB 0C 80 B7 ED 3D 70 0D 23 E1 DF F8 4C 2A 4A B2 EA 09 9D 20 16 45 B3 0B 4D 8D 7F 4A 44 CE F3 61 24 08 32 15 8D 89 A0 7C 21 21 27 AA 7E 5D 11 E9 07 90 83 69 E8 92
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\SavedLegacySettings: 46 00 00 00 10 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 C0 54 DE 4C 9C 19 D6 01 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 02 00 00 00 0A 00 00 02 00 00 00 00 00 00 00 00 01 00 00 00 05 00 00 00 08 B8 16 00 60 35 18 00 00 00 00 00 10 01 00 00 FF FF FF FF 00 00 00 00 0C 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 A8 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 40 9D 05 22 9E 7E CF 11 AE 5A 00 AA 00 A7 11 2B 6D 00 61 00 6C 00 77 00 61 00 72 00 65 00 00 00 00 00 00 00
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\SavedLegacySettings: 46 00 00 00 25 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 C0 54 DE 4C 9C 19 D6 01 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 02 00 00 00 0A 00 00 02 00 00 00 00 00 00 00 00 01 00 00 00 05 00 00 00 08 B8 16 00 60 35 18 00 00 00 00 00 10 01 00 00 FF FF FF FF 00 00 00 00 0C 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 A8 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 40 9D 05 22 9E 7E CF 11 AE 5A 00 AA 00 A7 11 2B 6D 00 61 00 6C 00 77 00 61 00 72 00 65 00 00 00 00 00 00 00

        # procexp (View > Lower Pane View > DLLS / Handles)
            NULL

        # procmon
            NULL

        # ApateDNS
            www.malwareanalysisbook.com
            EA 74 01 00 00 01 00 00  00 00 00 00 03 77 77 77            êt···········www
            13 6D 61 6C 77 61 72 65  61 6E 61 6C 79 73 69 73            ·malwareanalysis
            62 6F 6F 6B 03 63 6F 6D  00 00 01 00 01 00 00               book·com······· 

        # INetSim
            2020-04-26 19:25:43  HTTP connection, method: GET, URL: http://www.malwareanalysisbook.com/, file name: /var/lib/inetsim/http/fakefiles/sample.html
        
        # Wireshark
            GET / HTTP/1.1
            User-Agent: Internet Explorer 8.0
            Host: www.malwareanalysisbook.com
            Cache-Control: no-cache

        # autoruns
            Services
                HKLM\System\CurrentControlSet\Services				4/22/2020 11:10 AM
                    Malservice			c:\documents and settings\practice\desktop\lab07_01.exe	9/30/2011 12:49 PM

        # sc
            C:\Documents and Settings\practice>sc qc Malservice
            [SC] GetServiceConfig SUCCESS

            SERVICE_NAME: Malservice
                    TYPE               : 10  WIN32_OWN_PROCESS
                    START_TYPE         : 2   AUTO_START
                    ERROR_CONTROL      : 0   IGNORE
                    BINARY_PATH_NAME   : C:\Documents and Settings\practice\Desktop\Lab07_01.exe
                    LOAD_ORDER_GROUP   :
                    TAG                : 0
                    DISPLAY_NAME       : Malservice
                    DEPENDENCIES       :
                    SERVICE_START_NAME : LocalSystem

        # IDA Pro
            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            SERVICE_TABLE_ENTRYA ServiceStartTable; // [esp+0h] [ebp-10h]
            int v5; // [esp+8h] [ebp-8h]
            int v6; // [esp+Ch] [ebp-4h]

            ServiceStartTable.lpServiceName = aMalservice;                  // Malservice
            ServiceStartTable.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)sub_401040;
            v5 = 0;
            v6 = 0;
            StartServiceCtrlDispatcherA(&ServiceStartTable);
            return sub_401040();
            }

            int sub_401040()
            {
            SC_HANDLE v0; // esi
            HANDLE v1; // esi
            signed int v2; // esi
            SYSTEMTIME SystemTime; // [esp+0h] [ebp-400h]
            struct _FILETIME FileTime; // [esp+10h] [ebp-3F0h]
            CHAR Filename; // [esp+18h] [ebp-3E8h]

            if ( OpenMutexA(0x1F0001u, 0, Name) )         // HGL345
                ExitProcess(0);
            CreateMutexA(0, 0, Name);                     // HGL345
            v0 = OpenSCManagerA(0, 0, 3u);                // Service
            GetCurrentProcess();                          // Get the Image PATH for &Filename param of the following GetModuleFileNameA
            GetModuleFileNameA(0, &Filename, 0x3E8u);
            CreateServiceA(v0, DisplayName, DisplayName, 2u, 0x10u, 2u, 0, &Filename, 0, 0, 0, 0, 0);// 0x10u is the dwServiceType and the second 2u is the dwStartType. 0x02 for dwStartType means SERVICE_AUTO_START
            *(_DWORD *)&SystemTime.wYear = 0;
            *(_DWORD *)&SystemTime.wDayOfWeek = 0;
            *(_DWORD *)&SystemTime.wHour = 0;
            *(_DWORD *)&SystemTime.wSecond = 0;
            SystemTime.wYear = 2100;
            SystemTimeToFileTime(&SystemTime, &FileTime);
            v1 = CreateWaitableTimerA(0, 0, 0);
            SetWaitableTimer(v1, (const LARGE_INTEGER *)&FileTime, 0, 0, 0, 0);// wait until YEAR-2100
            if ( !WaitForSingleObject(v1, 0xFFFFFFFF) )   // Access the mutex
            {
                v2 = 20;
                do
                {
                CreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartAddress, 0, 0, 0);// access http://www.malwareanalysisbook.com
                --v2;                                     // 20 loops for Internet access till 2100
                }
                while ( v2 );
            }
            Sleep(0xFFFFFFFF);
            return 0;
            }
