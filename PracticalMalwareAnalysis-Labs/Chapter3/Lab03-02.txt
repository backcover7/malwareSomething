Lab03-02.dll
    PE Analysis
        # Virustotal
            63/71
            SHA-256: 5eced7367ed63354b4ed5c556e2363514293f614c2c2eb187273381b2ef5f0f9

        # PEid
            Microsoft Visual C++ 6.0 DLL [Overlay]

        # PEview
            TimeStamp (IMAGE_FILE_HEADER): 2010/09/28 Tue 01:00:25 UTC
            Subsystem (IMAGE_OPTIONAL_HEADER): IMAGE_SUBSYSTEM_WINDOWS_GUI (Graphic)
            Sections (Virtual Size / Size of Raw Data) -> No Packed
                .text: 3F0A/4000
                .rdata: 9A9/ A00
                .data: B5C8/600
                    EXPORT Address Table
                        Install
                        ServiceMain
                        UninstallService
                        installA
                        uninstallA
                .reloc: 83C/A00
        
        # Dependency Walker
            KERNEL32.DLL
                CloseHandle
                CreatePipe
                CreateProcessA
                CreateThread
                GetCurrentDirectoryA
                GetLastError
                GetLongPathNameA
                GetModuleFileNameA
                GetProcAddress
                GetStartupInfoA
                GetSystemTime
                GetTempPathA
                LoadLibraryA
                OutputDebugStringA
                ReadFile
                SetLastError
                Sleep
                TerminateThread
                WaitForSingleObject
                lstrlenA
            ADVAPI32.DLL
                CloseServiceHandle
                CreateServiceA
                DeleteService
                OpenSCManagerA
                OpenServiceA
                RegCloseKey
                RegCreateKeyA
                RegOpenKeyExA
                RegQueryValueExA
                RegSetValueExA
                RegisterServiceCtrlHandlerA
                SetServiceStatus
            WS2_32.DLL
            WININET.DLL
                HttpOpenRequestA
                HttpQueryInfoA
                HttpSendRequestA
                InternetCloseHandle
                InternetConnectA
                InternetOpenA
                InternetReadFile
            MSVCRT.DLL

        # strings.exe (Only part of the results)
            Install
            ServiceMain
            UninstallService
            installA
            uninstallA
            Y29ubmVjdA==                            // Base64deocde -> connect
            practicalmalwareanalysis.com
            serve.html
            dW5zdXBwb3J0
            c2xlZXA=                                // Base64deocde -> sleep
            Y21k
            cXVpdA==
            */*
            Windows XP 6.11
            CreateProcessA
            kernel32.dll
            .exe
            GET
            HTTP/1.1
            %s %s
            1234567890123456
            quit
            exit
            getfile
            cmd.exe /c                              // execution
            ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
            --!>
            <!--
            .PAX
            .PAD
            DependOnService
            RpcSs
            ServiceDll
            GetModuleFileName() get dll path
            Parameters
            Type
            Start
            ObjectName
            LocalSystem
            ErrorControl
            DisplayName
            Description
            Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.
            ImagePath
            %SystemRoot%\System32\svchost.exe -k                                                // !
            SYSTEM\CurrentControlSet\Services\
            CreateService(%s) error %d
            Intranet Network Awareness (INA+)
            %SystemRoot%\System32\svchost.exe -k netsvcs                                        // !
            OpenSCManager()
            You specify service name not in Svchost//netsvcs, must be one of following:
            RegQueryValueEx(Svchost\netsvcs)                                                    // check it!
                6to4                                                                            // rundll32 Lab03-02.dll,installA 6to4      // This will install the service named 6to4 rather than IPRIP
                AppMgmt
                AudioSrv
                Browser
                CryptSvc
                DMServer
                DHCP
                ERSvc
                EventSystem
                FastUserSwitchingCompatibility
                HidServ
                Ias
                Iprip
                Irmon
                LanmanServer
                LanmanWorkstation
                Messenger
                Netman
                Nla
                Ntmssvc
                NWCWorkstation
                Nwsapagent
                Rasauto
                Rasman
                Remoteaccess
                Schedule
                Seclogon
                SENS
                Sharedaccess
                SRService
                Tapisrv
                Themes
                TrkWks
                W32Time
                WZCSVC
                Wmi
                WmdmPmSp
                winmgmt
                wscsvc
                xmlprov
                napagent
                hkmsvc
                BITS
                wuauserv
                ShellHWDetection
                helpsvc
                WmdmPmSN
            netsvcs
            RegOpenKeyEx(%s) KEY_QUERY_VALUE success.
            RegOpenKeyEx(%s) KEY_QUERY_VALUE error .
            SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost                                // !
            IPRIP
            uninstall success
            OpenService(%s) error 2
            OpenService(%s) error 1
            uninstall is starting

    Dynamic Analysis
        # RegShot (Part of results)
            1shot
            rundll32.exe Lab03-02.dll,installA
            procexp: no more rundll32.exe
            2shot
            Compare

            ----------------------------------
            Keys added:6                                                                        // check all of them: the values below
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\IPRIP
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Security
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Security

            ----------------------------------
            Values added:20
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters\ServiceDll: "C:\Documents and Settings\practice\Desktop\Lab03-02.dll"
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Type: 0x00000020
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Start: 0x00000002
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\ErrorControl: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"                                  // ImagePath
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)"                                           // IoC
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\ObjectName: "LocalSystem"
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\Description: "Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes."
            HKLM\SYSTEM\ControlSet001\Services\IPRIP\DependOnService: 'RpcSs'
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Parameters\ServiceDll: "C:\Documents and Settings\practice\Desktop\Lab03-02.dll"
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Type: 0x00000020
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Start: 0x00000002
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ErrorControl: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"                               // ImagePath
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)"
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\ObjectName: "LocalSystem"
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\Description: "Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes."
            // IoC
            HKLM\SYSTEM\CurrentControlSet\Services\IPRIP\DependOnService: 'RpcSs'

            ----------------------------------
            Values modified:1
            ----------------------------------
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 92 5D 1B 1C 68 74 8D 4C 8C D1 CF 1A 27 5E C2 F1 7F 34 46 68 AD C2 2D 97 BF 49 D6 6E 6B 8A A2 0C FD AD A9 70 6E 08 D5 AB 61 15 B7 B4 95 E6 00 66 B1 81 88 85 98 C3 D6 BB 30 EE 94 4D 15 E2 97 8A 39 31 31 9C 0F 19 03 7A F9 56 EB 3C E2 57 21 F9
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 55 F4 53 C3 EF 53 17 A8 36 C5 7A 31 86 6F 49 32 0B E0 9E 3E 32 BD F6 FE 92 60 54 D0 0B AD B6 1B 98 74 9F DC 5C EA 1F 08 05 79 99 59 CD 9E E0 9D 32 40 02 E6 B0 84 11 0B 38 A1 E1 1B 49 73 D0 C5 CA 99 96 73 BA 9D 32 5B 0F 65 1F 64 12 18 F6 FE

            ----------------------------------
            Total changes:27
            ----------------------------------

        C:\Documents and Settings\practice\Desktop>net start IPRIP
        The Intranet Network Awareness (INA+) service is starting.
        The Intranet Network Awareness (INA+) service was started successfully.

        # procexp (View > Lower Pane View > DLLS / Handles)
            Find > Find Handle or DLL > Lab03-02.dll search
                svchost 1052    DLL
                    Commandline C:\WINDOWS\system32\svchost -k netsvcs
                    path        C:\WINDOWS\system32\svchost (netsvcs)
                    Services
                        ...
                        Intranet Network Awareness (INA+) (IPRIP)
                        ...

        # procmon
            #1 rundll32
                Filter
                    Process Name is Lab03-01.exe Include
                    Operation is RegSetValue Include

                Result
                    1:40:50.1631315 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 47 73 7E 66 A7 12 13 24 1B 6F 04 B6 94 D0 25 D0
                    1:40:50.5124441 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 05 58 4C C5 5F 6A DE 20 56 AE 12 66 32 84 2F 97
                    1:40:50.5127301 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: BD B2 E1 F7 53 51 FC E2 2F B7 52 90 32 C6 04 C1
                    1:40:50.5130285 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 58 FF 32 23 77 F0 11 C2 78 6D 25 2D D5 A2 64 AB
                    1:40:50.5133322 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 9F 7D D9 A1 51 BC F7 8D AF 9D 50 F6 EF 8B 88 FB
                    1:40:50.5135850 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: D5 AD 11 AD 7E F1 72 CA A0 46 15 6E 55 09 DA 5E
                    1:40:50.5138275 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: B4 5F 2B 1B 14 5C 49 C2 0D 25 E9 32 E7 43 A5 2B
                    1:40:50.5141015 PM	rundll32.exe	3720	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 7B 64 29 DE 70 F3 29 55 68 5D C2 A4 4E 46 CE 85
                    1:40:50.5553233 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\ImagePath	SUCCESS	Type: REG_EXPAND_SZ, Length: 90, Data: %SystemRoot%\System32\svchost.exe -k netsvcs
                    1:40:50.5553727 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\Description	SUCCESS	Type: REG_SZ, Length: 278, Data: Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.
                    1:40:50.5577929 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\DisplayName	SUCCESS	Type: REG_SZ, Length: 68, Data: Intranet Network Awareness (INA+)
                    1:40:50.5578317 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\ErrorControl	SUCCESS	Type: REG_DWORD, Length: 4, Data: 1
                    1:40:50.5578775 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\ObjectName	SUCCESS	Type: REG_SZ, Length: 24, Data: LocalSystem
                    1:40:50.5579250 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\Start	SUCCESS	Type: REG_DWORD, Length: 4, Data: 2
                    1:40:50.5579716 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\Type	SUCCESS	Type: REG_DWORD, Length: 4, Data: 32
                    1:40:50.5606181 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\Parameters\ServiceDll	SUCCESS	Type: REG_EXPAND_SZ, Length: 112, Data: C:\Documents and Settings\practice\Desktop\Lab03-02.dll
                    1:40:50.5659 598 PM	rundll32.exe	3720	RegSetValue	HKLM\System\CurrentControlSet\Services\IPRIP\DependOnService	SUCCESS	Type: REG_MULTI_SZ, Length: 14, Data: RpcSs

            #2 net start IPRIP
                Filter
                    Process Name is svchost.exe Include
                    ImagePath ends with \System32\svchost Include
                
                Result
                    Nothing valuable

        # ApateDNS
            DNS Reply IP: 10.0.0.1
            www.practicalmalwareanalysis.com
                67 54 01 00 00 01 00 00  00 00 00 00 03 77 77 77            gT···········www
                18 70 72 61 63 74 69 63  61 6C 6D 61 6C 77 61 72            ·practicalmalwar
                65 61 6E 61 6C 79 73 69  73 03 63 6F 6D 00 00 01            eanalysis·com···
                00 01 00 00                                                 ····   

        # INetSIM
            2020-04-23 18:51:59  DNS connection, type: A, class: IN, requested name: practicalmalwareanalysis.com
            2020-04-23 18:51:59  HTTP connection, method: GET, URL: http://practicalmalwareanalysis.com/serve.html, file name: /var/lib/inetsim/http/fakefiles/sample.html
            2020-04-23 18:51:59  Last simulated date in log file
        
        # nc -lvvp 80
            Listening on [0.0.0.0] (family 0, port 80)
            Connection from [10.0.0.2] port 80 [tcp/http] accepted (family 2, sport 1173)
            GET /serve.html HTTP/1.1
            Accept: */*
            User-Agent: malware Windows XP 6.11                 // mawlare is the hostname of the machine
            Host: practicalmalwareanalysis.com

Analysis
    The file Lab03-02.dll will depend on svchost.exe to execute the malicious code in it. And it will register a service and Intranet Network Awareness(INA+) and when we start the service it will access the /server.html of the website www.practicalmalwareanalysis.com.
