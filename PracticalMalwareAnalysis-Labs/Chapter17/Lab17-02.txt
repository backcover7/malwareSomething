Lab17-02.dll
    PE Analysis
        # Virustotal
            53/65
            SHA-256: 7f26bcad404867f92ee0f3de9257758132b2ea06884f436e7900e820ddd6646a

            PEiD packer
                Armadillo v1.xx - v2.xx

            TimeStamp: 2008-06-09 12:49:29

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	82694	82944	6.52	9e621865ed3b4f5526c39d0b112c3180
                .rdata	90112	8249	8704	5.32	8b0748079adebffd152ac8f9534b56fb
                .data	102400	499300	18944	7.46	2ee92300a42b42ee38438c00e04ff0c7
                xdoors_d	602112	11358	11776	5.09	6db3f9320ed52c071b4f6d1807db0951
                .rsrc	614400	944	1024	3.17	3d4a5136ca116a919b2688c93f988e59
                .reloc	618496	9384	9728	5.2	c77612bb04954176e12f6b2c0c9efde3

            IMPORT
                ADVAPI32.dll
                    RegDeleteKeyA
                    LookupPrivilegeValueA
                    RegCloseKey
                    OpenServiceA
                    QueryServiceConfigA
                    RegQueryValueExA
                    AdjustTokenPrivileges
                    ControlService
                    DeleteService
                    RegCreateKeyA
                    QueryServiceConfig2A
                    CloseServiceHandle
                    RegOpenKeyA
                    OpenProcessToken
                    CreateServiceA
                    QueryServiceStatus
                    SetTokenInformation
                    ChangeServiceConfig2A
                    RegEnumKeyA
                    RegDeleteValueA
                    DuplicateTokenEx
                    SetServiceStatus
                    CreateProcessAsUserA
                    RegOpenKeyExA
                    RegisterServiceCtrlHandlerA
                    EnumServicesStatusExA
                    ChangeServiceConfigA
                    QueryServiceStatusEx
                    RegSetValueExA
                    StartServiceA
                    RegEnumValueA
                    OpenSCManagerA
                GDI32.dll
                    GetObjectA
                    GetDeviceCaps
                    DeleteDC
                    CreateDCA
                    SetBkMode
                    GetStockObject
                    CreateCompatibleBitmap
                    SelectPalette
                    CreateFontIndirectA
                    SelectObject
                    GetDIBits
                    BitBlt                          // Screenshot
                    CreateDIBSection
                    CreateCompatibleDC
                    DeleteObject
                    RealizePalette
                    SetTextColor
                KERNEL32.dll
                    GetStdHandle
                    GetFileAttributesA
                    WaitForSingleObject
                    GetDriveTypeA
                    Thread32Next
                    SetFileTime
                    GetLocalTime
                    CreatePipe
                    GetCurrentProcess
                    LocalAlloc
                    GetLogicalDrives
                    GetFileTime
                    WideCharToMultiByte
                    WriteFile
                    Thread32First
                    GetDiskFreeSpaceA
                    SetFileAttributesA
                    LocalFree
                    MoveFileA
                    ResumeThread
                    InitializeCriticalSection
                    FindClose
                    OutputDebugStringA
                    SetLastError
                    GetSystemTime
                    WriteProcessMemory
                    CopyFileA
                    GetModuleFileNameA
                    GetVolumeInformationA
                    Module32First
                    MultiByteToWideChar
                    GlobalSize
                    CreateMutexA
                    CreateThread
                    GetExitCodeThread
                    Module32Next
                    GetSystemDirectoryA
                    MoveFileExA
                    SetPriorityClass
                    TerminateProcess
                    GlobalAlloc
                    GetVersion
                    SetCurrentDirectoryA
                    CreateToolhelp32Snapshot
                    EnterCriticalSection
                    OpenProcess
                    TerminateThread
                    LoadLibraryW
                    FreeLibrary
                    GetTickCount
                    GetVersionExA
                    LoadLibraryA
                    ExitThread
                    Process32Next
                    CreateRemoteThread
                    GetStartupInfoA
                    Process32First
                    CreateDirectoryA
                    DeleteFileA
                    GetWindowsDirectoryA
                    GlobalLock
                    GlobalReAlloc
                    FindFirstFileA
                    FreeConsole
                    GetComputerNameA
                    FindNextFileA
                    GlobalMemoryStatus
                    GetProcAddress
                    CreateFileA
                    LeaveCriticalSection
                    GetLastError
                    SystemTimeToFileTime
                    VirtualAllocEx
                    GlobalFree
                    GlobalUnlock
                    VirtualQuery
                    RemoveDirectoryA
                    WinExec
                    GetCurrentProcessId
                    ProcessIdToSessionId
                    GetCurrentDirectoryA
                    SuspendThread
                    GetSystemDefaultLangID
                    GetModuleHandleA
                    ReadFile
                    CloseHandle
                    GetCurrentThreadId
                    CreateProcessA
                    Sleep
                MSVCRT.dll
                MSVFW32.dll
                    ICImageCompress
                    ICSendMessage
                    ICClose
                    ICOpen
                    ICCompress
                OLEAUT32.dll
                    SysFreeString
                    VariantClear
                PSAPI.DLL
                    GetModuleFileNameExA
                    EnumProcessModules
                USER32.dll
                    RedrawWindow
                    OpenInputDesktop
                    DrawTextA
                    keybd_event
                    GetUserObjectInformationA
                    CloseDesktop
                    GetSystemMetrics
                    PostMessageA
                    MessageBoxA
                    SetProcessWindowStation
                    mouse_event
                    SetThreadDesktop
                    GetProcessWindowStation
                    OpenWindowStationA
                    GetDC
                    SystemParametersInfoA
                    SendMessageA
                    GetThreadDesktop
                    OpenDesktopA
                    CloseWindowStation
                    BlockInput
                    GetDesktopWindow
                    ReleaseDC
                    GetMessageA
                    ExitWindowsEx
                    PostThreadMessageA
                WINMM.dll
                    waveInOpen
                    waveInPrepareHeader
                    waveInAddBuffer
                    waveInClose
                    waveInUnprepareHeader
                    waveInStart
                    waveInReset
                WS2_32.dll
                    setsockopt
                    socket
                    closesocket
                    inet_addr
                    send
                    WSACleanup
                    WSAStartup
                    gethostbyname
                    WSAGetLastError
                    ntohs
                    connect
                    inet_ntoa
                    htons
                    recv
                    select
                iphlpapi.dll
                    GetAdaptersInfo
                ole32.dll
                    CoUninitialize
                    CoInitializeEx
                    CoCreateInstance
                    CoTaskMemFree
                    CoInitialize
            
            EXPORT
                InstallRT
                InstallSA
                InstallSB
                PSLIST
                ServiceMain
                StartEXS
                UninstallRT
                UninstallSA
                UninstallSB

        # strings.exe (Only part of the results)
            socket() GetLastError reports %d
            Plug_KeyLog_Restart
            xkey.dll
            WSAStartup() error: %d
            wb+
            125
            150
            RETR %s
            227
            PASV
            213
            SIZE %s
            TYPE I
            250
            CWD %s
            230
            PASS %s
            331
            USER %s
            Socket error....
            IEuser@
            anonymous
            FTP://
            ftp://
            Content-Length:
            HTTP/1.1 5
            HTTP/1.1 3
            HTTP/1.1 4
            Expires: 0
            Cache-Control: no-cache, must-revalidate
            Pragma: no-cache
            Connection: Keep-Alive
            User-Agent: Mozilla/4.0 (compatible; MSIE 6.00; Windows NT 5.1)
            Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*
            Host:
            HTTP/1.1
            GET
            HTTP://
            http://
            GetLastInputInfo
            user32.dll
            [%s %s]
            xinstall.log
            AdjustTokenPrivileges
            LookupPrivilegeValue
            SeDebugPrivilege
            error on %s, error code %d.
            OpenProcessToken
            0.0.0.0
            Microsoft TV/Video Connection
            VMware Virtual Ethernet Adapter
            Fail To Send()
            %s %s
            ftp:////
            http:////
            SeShutdownPrivilege
            HardwareInformation.MemorySize
            System
            \Device\Video0
            HARDWARE\DEVICEMAP\VIDEO
            F333
            kernel32.dll
            GetDiskFreeSpaceExA
            ~MHz
            HARDWARE\DESCRIPTION\System\CentralProcessor\0
            default
            GroupInfo
            HostInfo
            SOFTWARE\Microsoft\Windows\CurrentVersion
            Fail To Create Snap Shot
            (1) Enter Current Directory Error,Update Failed
            (2) Get DLL FileName Error,Update Failed
            (3) Move '%s' To '%s' Failed,Perhaps Other Process Updateing|Updated Same Module
            (4) Resume '%s' To '%s' Failed,Update Failed
            (4) Resume '%s' To '%s' Successfully,Update Failed
            (4) Get New FileName Error,Update Failed
            (6) Update Successfully,Will Take Effect Until Next Reboot
            (5) New FileName As Old FileName
            (6) Resume '%s' To '%s' Successfully,Update Failed!!!
            (5) Move '%s' To '%s' Failed,Update Failed
            (5) Copy '%s' To '%s' Successfully
            (4) Get New FileName '%s'
            (3) Move '%s' To '%s' Successfully
            .ubak
            (2) Get DLL FileName '%s'
            (1) Enter Current Directory '%s'
            ******************************
            [BackDoor Server Update Setup]
            ******************************
            -warn
            -erro
            -stop
            -shutdown
            -reboot
            Default
            WinSta0
            winsta0\default
            EXPLORER.EXE
            %s\IEXPLORE.EXE
            Path
            SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\IEXPLORE.EXE
            [Machine IdleTime:] %d days + %.2d:%.2d:%.2d
            [Machine UpTime:] %-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds
            [Language:] id:0x%x
            [Install Log:] %d
            [Detect VM  :] %d
            [SSDT Ring3 :] %d
            [SSDT Ring0 :] %d
            [Host connect Type  :] %d
            [Host Reconnect Time:] %d
            [CURL Reconnect Time:] %d
            [DOMAIN_NAME:]
            [CURL       :]
            [HOST_NAME  :]
            [PASS       :]
            [PORT       :]
            [HOST       :]
            [Module:]
            [Masthost:] %s:%s
            [Robot_WorkTimes:] %d
            WorkTimes
            [Robot_WorkTime :] %d
            WorkTime
            ServiceDll
            SYSTEM\CurrentControlSet\Services\%s\Parameters\
            SYSTEM\CurrentControlSet\Services\
            del %%0
            if exist "%s" goto selfkill
            del "%s"
            attrib -a -r -s -h "%s"
            :selfkill
            @echo off
            .\vmselfdel.bat
            kstarttype
            CreateToolhelp32Snapshot
            OpenProcess
            WaitForSingleObject
            CreateRemoteThread
            failed
            Load the sfc fuction failed
            unsupported version
            Windows XP
            sfc_os.dll
            Win2000
            sfc.dll
            error on get process info.
            winlogon.exe
            xinstall.dll
            AdjustTokenPrivileges failed: %u
            LookupPrivilegeValue error:%d
            ntdll.dll
            NtQuerySystemInformation
            %-16d%-20s%d
            [%s]
            ProcessID       ProcessName         ThreadNumber
            Process32First() Fail:Error %d
            [%s]
            %-16d%-20s%d
            CreateToolhelp32Snapshot Fail:Error%d
            OpenProcessToken Error: %d
            kernel32
            OpenThread
            smss.exe
            csrss.exe
            lsass.exe
            services.exe
            svchost.exe
            Winlogon
            winsta0
            WmsgSendMessage
            wmsgapi.dll
            DISPLAY
            .scr
            WinSta0\Winlogon
            WinSta0\Default
            logonui.exe
            rundll32.exe %s,StartEXS %s:%s
            explorer.exe
            %s\
            %s%s
            %s\%s
            *.*
            1234567890
            %s
            System Volume Information
            %s*.*
            HKEY_USERS
            HKEY_LOCAL_MACHINE
            HKEY_CURRENT_USER
            HKEY_CURRENT_CONFIG
            HKEY_CLASSES_ROOT
            FriendlyName
            Grabber
            Capture Filter
            AudioInThreadProc exit.
            MM_WIM_CLOSE
            AudioInThreadProc start.
            CWaveIn::CloseDev: Device hasn't opened.
            CWaveIn::OpenDev: waveInOpen error.
            CWaveIn::OpenDev: Device has open.
            CWaveIn::StartThread: Strat wave in thread fail.
            CWaveIn::StartThread: Wave in thread has run.
            CWaveIn::StopThread: TerminateThread wave in thread.
            CWaveIn::StopThread: Wave in thread hasn't run.
            CWaveIn::PerPareBuffer: waveInAddBuffer error.
            CWaveIn::PerPareBuffer: waveInPrepareHeader error.
            CWaveIn::PerPareBuffer: waveInReset error.
            CWaveIn::PerPareBuffer: Buffer has been alloc.
            CWaveIn::FreeBuffer: waveInUnprepareHeader error.
            CWaveIn::FreeBuffer: m_pHdr is NULL.
            CWaveIn::FreeBuffer: Buffer hasn't been alloc.
            CWaveIn::OpenRecord: waveInStart error.
            CWaveIn::OpenRecord: You may be has begun recored.
            CWaveIn::CloseRecord: waveInReset error.
            CWaveIn::CloseRecord: Device hasn't opened.
            CWaveIn::CloseRecord: You may be hasn't begun recored.
            Completed
            SoftWare\MicroSoft\Internet Connection Wizard\
            MyStarService() -> OpenService() Error
            MyStarService() -> StartService() Error.
            StartService '%s' Successfully
            Open SCM error!
            MyStopService() -> OpenService() Error.
            MyStopService() -> ControlService() Error
            StopService '%s' Successfully
            Service '%s' Status already is Stopped.
            MyChangeService() -> OpenService '%s' Error.
            Change Service '%s' To Be Disabled
            Change Service '%s' To Be Manual-Start
            Change Service '%s' To Be Auto-Start
            Change Service '%s' Config Failed!
            Query registry service config failed!
            Alloc memory failed!
            Service '%s' Start Type Already Is Auto
            MyQueryServiceStarttype() -> OpenService '%s' Error.
            Query service starttype->%d
            _ox.dll
            .obak
            regedit.exe
            mmc.exe
            WatchaaaaaaaaMExeMutex
            GetModuleFileName() get dll path
            Kernel32
            LoadLibraryW
            Not Found Module '%s' In Any '%s' Process
            Found Module '%s' In PID %d
            Process '%s' Not Found ,Inject Failed
            Inject '%s' To Process '%s' Failed
            Inject '%s' To Process '%s' Successfully
            The PID Of Process '%s' is '%d'
            iexplore.exe
            Copy '%s' To '%s' Failed
            Copy '%s' To '%s' Successfully
            The PID Of Process '%s' Not Found
            Inject '%s' To Process '%s' Failed
            Inject '%s' To Process '%s' Successfully
            The PID Of Process '%s' is '%d'
            Copy '%s' To '%s' Failed
            Copy '%s' To '%s' Successfully
            Found Virtual Machine,Install Cancel.
            Description
            SYSTEM\ControlSet001\Services\
            win.ini
            Config service %s ok.
            %s error %d
            RegSetValueEx(ServiceDll)
            %SystemRoot%\system32\
            RegCreateKey(Parameters)
            Parameters
            RegOpenKeyEx(%s) KEY_SET_VALUE error %d.
            CreateService(%s) With Description '%s' SUCCESS. Config it
            CreateService(%s) error %d
            %SystemRoot%\System32\svchost.exe -k netsvcs
            OpenSCManager()
            Now Will Install Default Service '%s' With Description '%s'
            - %s
            you specify service name not in Svchost\netsvcs, must be one of following:
            RegQueryValueEx(Svchost\netsvcs)
            netsvcs
            RegOpenKeyEx(%s) KEY_QUERY_VALUE error %d.
            SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost
            %s System Services
            Irmon
            Replace Old Service '%s' Failed,Install Cancle
            Old Module Not Runing,New ModuleName As Old,Will Take Effect Soon.
            Old Module Have Been Free,New ModuleName As Old,Will Take Effect Soon.
            %s.obak
            %s\dllcache\%s
            Inject '%s' to  PID '%d' Successfully!
            Old Module '%s' Still Runing,New Module '%s' Will Inject To PID '%d'
            Service '%s' Infect Successfully
            ServiceDll Set As '%s' Successfully
            ServiceMain Set As 'ServiceMain'
            RegSetValueEx(ServiceMain)
            ServiceMain
            RegQueryValueEx(%s) KEY_SET_VALUE error %d.
            Services '%s' Have Been Infected! Install Failed!
            ServiceMainbak
            \Parameters
            You Specify Service Name Not In Svchost\netsvcs, must be one of following:
            NtmsSvc
            Exception Catched 0x%X
            DeleteService(%s) SUCCESS.
            OpenService(%s) error %d
            OpenSCManager() error %d
            Service '%s' Do Not Need UnInstall.
            Service '%s' UnInstall Falied 2.
            Service '%s' UnInstall Falied 1.
            Service '%s' UnInstall Successfully,Please Reboot Machine To Take Effect
            ServiceMain Reset to '%s'
            Move '%s' To '%s' Successfully
            .\dllcache\%s
            %s.pbak
            ServiceDll Reset to '%s'
            .dll
            _ox
            Kernel32.dll
            FreeLibrary
            Process '%s' Not Found,Uninject Failed
            Uninject '%s' From Process '%s' Failed
            Uninject '%s' From Process '%s' Failed, Module '%s' Not Found
            Uninject '%s' From Process '%s' Successfully
            '%s' Repair Failed,Bak File Lose!
            '%s' Repair Successfully,Need Reboot Machine!
            Move '%s' To '%s' Failed
            _bd.dll
            .pe
            conime.exe
            MayBe Inject Mode,You Only Need Close Master Process '%s' To Uninatll This Mode
            No Found Old Bak Pe File->'%s'
            Now Run UninstallPE %s
            Found Old Bak Pe File->'%s'
            Get MasterProecss Path->'%s'
            Now Run UninstallSB %s
            Now Run UninstallSA %s
            Get ServiceName->'%s'
            Get ProcessName->'%s'
            Get ModuleName->'%s'
            Get ModulePath->'%s'
            Get Install Way->InstallRT
            Get Install Way->InstallPE
            Get Install Way->InstallSB Or InstallRSB
            Get Install Way->InstallSA
            Get ServiceName->'%s'
            Get ProcessName->'%s'
            Get ModuleName->'%s'
            Get ModulePath->'%s'
            CreateProcess() GetLastError reports %d
            inject
            minstall
            mmodule
            mhost
            mbase
            robotwork
            language
            uptime
            idle
            0x%02x
            enmagic
            exit
            quit
            \command.exe /c
            \cmd.exe /c
            Hi,Master [%d/%d/%d %d:%d:%d]
            WelCome Back...Are You Enjoying Today?
            Machine UpTime  [%-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds]
            Machine IdleTime [%-.2d Days %-.2d Hours %-.2d Minutes %-.2d Seconds]
            Encrypt Magic Number For This Remote Shell Session [0x%02x]
            VS_VERSION_INFO
            StringFileInfo
            080404b0
            CompanyName
            Microsoft Corporation
            FileDescription
            File Encryption Utility
            FileVersion
            5.1.2201.1329
            InternalName
            X-doorc
            LegalCopyright
            (C) Microsoft Corporation. All rights reserved.
            OriginalFilename
            ProductName
            Microsoft(R) Windows(R) Operating System
            ProductVersion
            5.1.2201.1329
            VarFileInfo
            Translation

    Dynamic Analysis
        # RegShot (Part of results)
            ----------------------------------
            Keys added:22
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Control
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Control
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Enum
            HKLM\SYSTEM\ControlSet001\Services\Irmon
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Parameters
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Security
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Enum
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Control
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Control
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Enum
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Parameters
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Security
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Enum

            ----------------------------------
            Values added:68
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Control\ActiveService: "Irmon"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Service: "Irmon"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Legacy: 0x00000001
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\0000\DeviceDesc: "Irmon System Services"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_IRMON\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Control\ActiveService: "NtmsSvc"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Service: "NtmsSvc"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Legacy: 0x00000001
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\0000\DeviceDesc: "Removable Storage"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_NTMSSVC\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\kmixer\Enum\0: "SW\{b7eafdc0-a680-11d0-96d8-00aa0051e51d}\{9B365890-165F-11D0-A195-0020AFD156E4}"
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Enum\0: "Root\LEGACY_NTMSSVC\0000"
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Enum\Count: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Enum\0: "Root\LEGACY_IRMON\0000"
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Enum\Count: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Parameters\ServiceDll: "C:\Documents and Settings\practice\Desktop\Lab17-02.dll"
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Type: 0x00000120
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Start: 0x00000002
            HKLM\SYSTEM\ControlSet001\Services\Irmon\ErrorControl: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\Irmon\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"
            HKLM\SYSTEM\ControlSet001\Services\Irmon\DisplayName: "Irmon System Services"
            HKLM\SYSTEM\ControlSet001\Services\Irmon\ObjectName: "LocalSystem"
            HKLM\SYSTEM\ControlSet001\Services\Irmon\Description: ""
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Control\ActiveService: "Irmon"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Service: "Irmon"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Legacy: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\0000\DeviceDesc: "Irmon System Services"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_IRMON\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Control\ActiveService: "NtmsSvc"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Service: "NtmsSvc"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Legacy: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\0000\DeviceDesc: "Removable Storage"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_NTMSSVC\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\kmixer\Enum\0: "SW\{b7eafdc0-a680-11d0-96d8-00aa0051e51d}\{9B365890-165F-11D0-A195-0020AFD156E4}"
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Enum\0: "Root\LEGACY_NTMSSVC\0000"
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Enum\Count: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Enum\0: "Root\LEGACY_IRMON\0000"
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Enum\Count: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Parameters\ServiceDll: "C:\Documents and Settings\practice\Desktop\Lab17-02.dll"
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Type: 0x00000120
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Start: 0x00000002
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\ErrorControl: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\DisplayName: "Irmon System Services"
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\ObjectName: "LocalSystem"
            HKLM\SYSTEM\CurrentControlSet\Services\Irmon\Description: ""

            ----------------------------------
            Values modified:7
            ----------------------------------
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: A5 19 A0 55 43 12 6A EF A3 C3 85 C5 39 AD 75 35 C4 14 0E 20 50 37 C5 0F 5E A2 F4 6B 91 70 5F 2A 52 A5 89 D6 21 61 B0 85 04 AD AA 05 B6 43 CD 2D 46 EE 1C 74 0F 4F B5 F3 00 64 8C 33 3E 82 F3 CB 0D 2C FB 02 5C 19 07 44 B2 71 2B 43 88 50 08 AE
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: D5 9D 1F 69 BE F8 23 E4 AD DD 2B 7C 6C 49 5E 0E 79 DD 69 65 C7 62 17 13 3B C6 7E 58 63 49 86 81 76 B4 3A 69 67 F3 E3 EF B4 80 08 F1 E6 0B EB D5 CF AD F9 B0 39 40 62 1C 6F 3F D2 FB 01 54 36 FA 91 CB D8 4F 44 C6 1F 48 B4 98 1F 4B C9 92 CD 97
            HKLM\SYSTEM\ControlSet001\Services\kmixer\Enum\Count: 0x00000000
            HKLM\SYSTEM\ControlSet001\Services\kmixer\Enum\Count: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\kmixer\Enum\NextInstance: 0x00000000
            HKLM\SYSTEM\ControlSet001\Services\kmixer\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Start: 0x00000003
            HKLM\SYSTEM\ControlSet001\Services\NtmsSvc\Start: 0x00000002
            HKLM\SYSTEM\CurrentControlSet\Services\kmixer\Enum\Count: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Services\kmixer\Enum\Count: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\kmixer\Enum\NextInstance: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Services\kmixer\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Start: 0x00000003
            HKLM\SYSTEM\CurrentControlSet\Services\NtmsSvc\Start: 0x00000002

            ----------------------------------
            Total changes:97
            ----------------------------------

        # procexp
            svchost.exe	svchost.exe		15,284 K	26,016 K	1052	Generic Host Process for Win32 Services	Microsoft Corporation
                wscntfy.exe	wscntfy.exe		676 K	2,576 K	1868	Windows Security Center Notification App	Microsoft Corporation

        # procmon
            Filter
                Process Name is rundll32.exe Include
                Operation is WriteFile Include

            Result              (Should create a file vmselfdel.bat)
                4:29:15.2118899 PM	rundll32.exe	2932	WriteFile	C:\Documents and Settings\practice\Desktop\xinstall.log	SUCCESS	Offset: 234, Length: 25
                4:29:15.2655892 PM	rundll32.exe	2932	RegSetValue	HKLM\System\CurrentControlSet\Services\Irmon\Parameters\ServiceDll	SUCCESS	Type: REG_EXPAND_SZ, Length: 112, Data: C:\Documents and Settings\practice\Desktop\Lab17-02.dll
                4:29:20.2954933 PM	rundll32.exe	3124	WriteFile	C:\WINDOWS\system32\ntmssvc.dll.obak	SUCCESS	Offset: 327,680, Length: 65,536
                4:29:20.3343474 PM	rundll32.exe	3124	WriteFile	C:\WINDOWS\system32\ntmssvc.dll	SUCCESS	Offset: 65,536, Length: 65,536
                4:29:20.4037953 PM	rundll32.exe	3124	WriteFile	C:\WINDOWS\system32\dllcache\ntmssvc.dll	SUCCESS	Offset: 0, Length: 65,536

            xinstall.logonui
                VMware
                    [05/10/20 20:29:15]
                    Found Virtual Machine,Install Cancel.

                Virtual Box
                    [05/10/20 16:29:10]         // InstallRT
                    Copy 'C:\Documents and Settings\practice\Desktop\Lab17-02.dll' To 'C:\WINDOWS\system32\Lab17-02.dll' Successfully
                    The PID Of Process 'iexplore.exe' is '3764'
                    Inject 'Lab17-02.dll' To Process 'iexplore.exe' Successfully


                    [05/10/20 16:29:15]         // InstallSA
                    CreateService(Irmon) With Description '' SUCCESS. Config it
                    Config service Irmon ok.
                    StartService 'Irmon' Successfully


                    [05/10/20 16:29:18]         // InstallSB
                    Query service starttype->3
                    Change Service 'NtmsSvc' To Be Auto-Start
                    Service 'NtmsSvc' Status already is Stopped.
                    Not Found Module 'ntmssvc.dll' In Any 'svchost.exe' Process
                    Copy 'C:\WINDOWS\system32\ntmssvc.dll' To 'C:\WINDOWS\system32\ntmssvc.dll.obak' Successfully
                    Copy 'C:\Documents and Settings\practice\Desktop\Lab17-02.dll' To 'C:\WINDOWS\system32\ntmssvc.dll' Successfully
                    Copy 'C:\Documents and Settings\practice\Desktop\Lab17-02.dll' To 'C:\WINDOWS\system32\dllcache\ntmssvc.dll' Successfully
                    Old Module Not Runing,New ModuleName As Old,Will Take Effect Soon.
                    StartService 'NtmsSvc' Successfully


        # autoruns
            HKLM\System\CurrentControlSet\Services				4/22/2020 11:10 AM
                Irmon		Microsoft Corporation	c:\documents and settings\practice\desktop\lab17-02.dll	6/9/2008 5:49 AM

        # ApateDNS
            www.practicalmalwareanalysis.com

        # Netcat
            $ sudo nc -lvvp 80
            Listening on [0.0.0.0] (family 0, port 80)
            Connection from [10.0.0.2] port 80 [tcp/http] accepted (family 2, sport 1183)
            GET /tt.html HTTP/1.1
            Accept: */*
            Accept-Encoding: gzip, deflate
            User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; .NET CLR 2.0.50727)
            Host: www.practicalmalwareanalysis.com
            Connection: Keep-Alive

        # sc
            C:\Documents and Settings\practice>sc query Irmon

            SERVICE_NAME: Irmon
                    TYPE               : 120  WIN32_SHARE_PROCESS (interactive)
                    STATE              : 1  STOPPED
                                            (NOT_STOPPABLE,NOT_PAUSABLE,IGNORES_SHUTDOWN)
                    WIN32_EXIT_CODE    : 0  (0x0)
                    SERVICE_EXIT_CODE  : 0  (0x0)
                    CHECKPOINT         : 0x0
                    WAIT_HINT          : 0x0

            C:\Documents and Settings\practice>sc qc Irmon
            [SC] GetServiceConfig SUCCESS

            SERVICE_NAME: Irmon
                    TYPE               : 120  WIN32_SHARE_PROCESS (interactive)
                    START_TYPE         : 2   AUTO_START
                    ERROR_CONTROL      : 1   NORMAL
                    BINARY_PATH_NAME   : C:\WINDOWS\System32\svchost.exe -k netsvcs
                    LOAD_ORDER_GROUP   :
                    TAG                : 0
                    DISPLAY_NAME       : Irmon System Services
                    DEPENDENCIES       :
                    SERVICE_START_NAME : LocalSystem

        # IDA Pro
            Strings subview > search vmselfdel.bat
                xdoors_d:100941C0 aVmselfdelBat   db '.\vmselfdel.bat',0  ; 

            Down	p	InstallRT+40	call    sub_10005567
            Down	p	InstallSA+40	call    sub_10005567
            Down	p	InstallSB+40	call    sub_10005567

            UINT __stdcall InstallRT(int a1, int a2, int a3, int a4)
            {
            if ( atoi(off_10019034[0] + 13) && (sub_10006119() || sub_10006196()) )         // [This is DVM]5, This could be modified to [This is DVM]0 in winhex ;// sub_10006119 is empty, so sub_10006196 contains anti vm code.
            {
                sub_10003592(unk_1008E5F0, v6);
                sub_10003592(aFoundVirtualMa, v4);
                result = sub_10005567();                // vmselfdel.bat
            }
            else
            {
                atoi(off_1001902C[0] + 13);
                result = sub_1000D3D0(a3);
            }
            return result;
            }

            sub_10006196
                .text:100061C7                 mov     eax, 'VMXh'
                .text:100061CC                 mov     ebx, 0
                .text:100061D1                 mov     ecx, 0Ah
                .text:100061D6                 mov     edx, 'VX'                // 0x5658 <- communication port of VMware and host.
                .text:100061DB                 in      eax, dx
                .text:100061DC                 cmp     ebx, 'VMXh'