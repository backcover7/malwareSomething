Lab17-02.dll
    Similar to Lab12-02.exe

    # IDA Pro
        First ANTI-VM
            Number of potential Anti-VM instructions: 1
            Anti-VM: 00401ac8

            .text:00401AC8                 in      eax, dx

            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            if ( sub_401A80() )             // vm detection
                return 0;

            .text:0040199A                 call    sub_401A80
            .text:0040199F                 test    eax, eax                 // OllyDbg > xor eax, eax > to forbid antivm
            .text:004019A1                 jz      short loc_4019AA
            .text:004019A3                 xor     eax, eax
            .text:004019A5                 jmp     loc_401A71

        Second ANTI-VM
            Strings subview > search vmware
                .data:00403040 aVmware         db 'vmware',0           ; DATA XREF: sub_4011C0+117↑o

                main()
                if ( sub_4011C0(HKEY_LOCAL_MACHINE, SubKey, 2) )          // contains string 'vmware'
                    return 0;

                int __cdecl sub_4011C0(HKEY hKey, LPCSTR lpSubKey, int a3)
                {
                cSubKeys = 0;
                v11 = 0;
                if ( !a3 )
                    return 0;
                if ( !RegOpenKeyExA(hKey, lpSubKey, 0, 0x20019u, &phkResult) )// HKLM\SYSTEM\CurrentControlSet\Control\DeviceClasses
                {
                    cchClass = 256;
                    if ( !RegQueryInfoKeyA(phkResult, &Class, &cchClass, 0, &cSubKeys, 0, 0, 0, 0, 0, 0, 0) )
                    {
                    cchName = 256;
                    dwIndex = 0;
                    while ( dwIndex < cSubKeys )
                    {
                        if ( !RegEnumKeyExA(phkResult, dwIndex, &Name, &cchName, 0, 0, 0, 0) )
                        {
                        qmemcpy(&v4, &Name, cchName);
                        toLower((int)&v4);
                        if ( str_cmp(&v4, aVmware) )          // vmware
                        {
                            v11 = 1;
                            break;
                        }
                        if ( sub_4011C0(phkResult, &Name, a3 - 1) )
                        {
                            v11 = 1;
                            break;
                        }
                        }
                        ++dwIndex;
                        cchName = 256;
                    }
                    }
                    RegCloseKey(phkResult);
                }
                return v11;
                }

        Third ANTI-VM
            Strings subview > search GetAdaptersInfo
                .data:004030B4 aGetadaptersinf db 'GetAdaptersInfo',0  ; DATA XREF: _main:loc_4019C9↑o

            main()
                v4 = LoadLibraryA(Iphlpapi_dll);
                GetAdaptersInfo_addr = (int)GetProcAddress(v4, GetAdaptersInfo);
                
                    .data:00403114 GetAdaptersInfo_addr dd 0               ; DATA XREF: sub_401670+B1↑r
                    .data:00403114                                         ; sub_401670+FE↑r ...

            Structure > Insert standard > IP_ADAPTER_INFO
                .text:00401797 loc_401797:                             ; CODE XREF: sub_401670+106↑j
                .text:00401797                                         ; sub_401670+1AE↓j
                .text:00401797                 cmp     [ebp+lpMem], 0
                .text:0040179B                 jz      loc_401823
                .text:004017A1                 mov     edx, [ebp+lpMem]
                .text:004017A4                 cmp     [edx+_IP_ADAPTER_INFO.Type], 6                   // Ethernet
                .text:004017AB                 jz      short loc_4017B9
                .text:004017AD                 mov     eax, [ebp+lpMem]
                .text:004017B0                 cmp     [eax+_IP_ADAPTER_INFO.Type], 71h                 // 802.11
                .text:004017B7                 jnz     short loc_401816
                .text:004017B9
                .text:004017B9 loc_4017B9:                             ; CODE XREF: sub_401670+13B↑j
                .text:004017B9                 mov     ecx, [ebp+lpMem]
                .text:004017BC                 cmp     [ecx+_IP_ADAPTER_INFO.AddressLength], 2
                .text:004017C3                 jbe     short loc_401816
                .text:004017C5                 mov     [ebp+var_3C], 0
                .text:004017CC                 jmp     short loc_4017D7
                .text:004017CE ; ---------------------------------------------------------------------------
                .text:004017CE
                .text:004017CE loc_4017CE:                             ; CODE XREF: sub_401670:loc_401814↓j
                .text:004017CE                 mov     edx, [ebp+var_3C]
                .text:004017D1                 add     edx, 3
                .text:004017D4                 mov     [ebp+var_3C], edx
                .text:004017D7
                .text:004017D7 loc_4017D7:                             ; CODE XREF: sub_401670+15C↑j
                .text:004017D7                 cmp     [ebp+var_3C], 1Bh
                .text:004017DB                 jnb     short loc_401816
                .text:004017DD                 mov     ecx, 3
                .text:004017E2                 mov     eax, [ebp+var_3C]
                .text:004017E5                 lea     edi, [ebp+eax+var_38]
                .text:004017E9                 mov     esi, [ebp+lpMem]
                .text:004017EC                 add     esi, _IP_ADAPTER_INFO.Address
                .text:004017F2                 xor     edx, edx
                .text:004017F4                 repe cmpsb                                               // compare the first 3 bytes of IP_ADAPTER_INFO.Address to Byte_Array (Compare the MAC to VMWARE known mac prefix)
            
