Lab09-03.exe
    PE Analysis
        # Virustotal
            17/72
            SHA-256: 1fc6a471b2a46cd882246d5bdc9d5954bf8efacf68b4e549a9756e6616848884

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2011-05-16 20:43:56

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	13726	16384	5.92	5fa4178985a9032ea14fcbc292b6ded2
                .rdata	20480	2194	4096	3.42	478631e61dccc25a4d6bfe3438038df9
                .data	24576	10812	12288	0.42	a388b130d0804c491453baefe11bdc89

            IMPORT
                DLL1.dll
                    DLL1Print
                DLL2.dll
                    DLL2ReturnJ
                    DLL2Print
                KERNEL32.DLL
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    GetCurrentProcess
                    GetEnvironmentStrings
                    GetCPInfo
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    WideCharToMultiByte
                    GetStringTypeA
                    GetModuleHandleA
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    TerminateProcess
                    GetEnvironmentVariableA
                    HeapCreate
                    VirtualFree
                    Sleep
                    GetFileType
                    HeapAlloc
                    GetVersion
                    VirtualAlloc
                NETAPI32.dll
                    NetScheduleJobAdd

        # strings.exe (Only part of the results)
            malwareanalysisbook.com

    Dynamic Analysis
        # RegShot (Part of results)
            ----------------------------------
            Values added:2
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\Schedule\AtTaskMaxHours: 0x00000048
            HKLM\SYSTEM\CurrentControlSet\Services\Schedule\AtTaskMaxHours: 0x00000048

            ----------------------------------
            Values modified:2
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Services\Schedule\NextAtJobId: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\Schedule\NextAtJobId: 0x00000002
            HKLM\SYSTEM\CurrentControlSet\Services\Schedule\NextAtJobId: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\Schedule\NextAtJobId: 0x00000002

        # procexp (View > Lower Pane View > DLLS / Handles)
            NULL

        # procmon
            Filter
                Process Name is Lab09-03.exe Include
                Operation is WriteFile Include
            
            Result
                8:40:29.4109826 PM	Lab09-03.exe	2272	WriteFile	C:\Documents and Settings\practice\Desktop\temp.txt	SUCCESS	Offset: 0, Length: 23
                
        # autoruns
            NULL

        # ApateDNS
            NULL

        # IDA Pro
        int __cdecl main(int argc, const char **argv, const char **envp)
        {
        DLL1Print();
        DLL2Print();
        hFile = (HANDLE)DLL2ReturnJ();                                                      // hFile is the handle of temp.txt
        WriteFile(hFile, malwareanalysisbook_com, 0x17u, &NumberOfBytesWritten, 0);
        CloseHandle(hFile);
        hModule = LoadLibraryA(DLL3_dll);
        v9 = (void (*)(void))GetProcAddress(hModule, DLL3Print);
        v9();
        v7 = GetProcAddress(hModule, DLL3GetStructure);
        ((void (__cdecl *)(LPBYTE *))v7)(&Buffer);
        NetScheduleJobAdd(0, Buffer, &JobId);                                               // Buffer from DLLMain() in DLL3.dll
        Sleep(10000u);
        return 0;
        }

        From the Imports window we know DLL1.dll, DLL2.dll will be imported and loaded.
        We found LoadLibraryA in Imports windows and the args of it.
        .text:0040103C                 push    offset DLL3_dll ; "DLL3.dll"         // DLL3.dll will be loaded.
        .text:00401041                 call    ds:LoadLibraryA

        # OllyDbg
            F2 0x00401041 > F9 > View > Memory map
                Owner = DLL1            10000000 (self)
                Owner = DLL2            00330000 (self)
                Owner = DLL3            00390000 (self)

            

DLL1.dll
    PE Analysis
        # Virustotal
            8/68
            SHA-256: 5ac89a17fc6225416cde2c3935c277fa9b9db51f5690285e7d565d04719abdce

            PEiD packer
                Microsoft Visual C++ v6.0 DLL

            TimeStamp: 2011-10-01 18:25:55

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	21754	24576	6.16	9d0ac6e7a1ae61f4cd5c86b87f7cf4b1
                .rdata	28672	3013	4096	4.35	bd3960793dcf679d8b21cfe8c4348fa9
                .data	32768	17420	12288	0.72	4d9b83832e6de9aa8cb1eb7a6067b378
                .reloc	53248	3354	4096	3.36	fe29a421826877cffd2f81537d072704

            IMPORT
                KERNEL32.DLL
                    GetLastError
                    InitializeCriticalSection
                    HeapFree
                    GetStdHandle
                    EnterCriticalSection
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    TlsAlloc
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    DeleteCriticalSection
                    GetCurrentProcess
                    GetEnvironmentStrings
                    GetCurrentProcessId
                    GetCPInfo
                    InterlockedDecrement
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    GetStringTypeA
                    SetStdHandle
                    SetFilePointer
                    WideCharToMultiByte
                    TlsFree
                    GetModuleHandleA
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    GetCurrentThreadId
                    TerminateProcess
                    GetEnvironmentVariableA
                    HeapCreate
                    VirtualFree
                    TlsGetValue
                    GetFileType
                    TlsSetValue
                    HeapAlloc
                    GetVersion
                    InterlockedIncrement
                    VirtualAlloc
                    SetLastError
                    LeaveCriticalSection

            EXPORT
                DLL1Print

        # PEview
            IMAGE_OPTIONAL_HEADER
                IMAGE_BASE: 0x10000000

        # strings.exe (Only part of the results)
            H:mm:ss
            dddd, MMMM dd, yyyy
            M/d/yy
            December
            November
            October
            September
            August
            July
            June
            April
            March
            February
            January
            Saturday
            Friday
            Thursday
            Wednesday
            Tuesday
            Monday
            Sunday
            SunMonTueWedThuFriSat
            JanFebMarAprMayJunJulAugSepOctNovDec
            DLL 1 mystery data %d

        # IDA Pro
            int DLL1Print()
            {
            return printf("DLL 1 mystery data %d", dword_10008030);             // From DLLMain()
            }

            BOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
            {
            BOOL result; // eax

            result = GetCurrentProcessId();
            dword_10008030 = result;
            LOBYTE(result) = 1;
            return result;
            }

DLL2.dll
    PE Analysis
        # Virustotal
            4/70
            SHA-256: 9151b583754221ae1bf764d24edfd7c3a4c0377b4118d4d0e13615124059de8c

            PEiD packer
                Microsoft Visual C++ v6.0 DLL

            TimeStamp: 	2011-10-01 18:25:56

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	21786	24576	6.16	2023b5cf569b65b2772ffbaf4c38dcbf
                .rdata	28672	3035	4096	4.36	9c4c3115c9babfc69a3580f8094fef60
                .data	32768	17420	12288	0.73	8415b5b63448940f3ee43ab76642d735
                .reloc	53248	3358	4096	3.37	458f9e78556e386295a03dfdbb96b3c7

            IMPORT
                KERNEL32.DLL
                    GetLastError
                    InitializeCriticalSection
                    HeapFree
                    GetStdHandle
                    EnterCriticalSection
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    TlsAlloc
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    DeleteCriticalSection
                    GetStartupInfoA
                    GetEnvironmentStrings
                    GetCPInfo
                    InterlockedDecrement
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    GetStringTypeA
                    SetStdHandle
                    SetFilePointer
                    WideCharToMultiByte
                    TlsFree
                    GetModuleHandleA
                    WriteFile
                    GetCurrentProcess
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    GetCurrentThreadId
                    TerminateProcess
                    GetEnvironmentVariableA
                    HeapCreate
                    VirtualFree
                    TlsGetValue
                    GetFileType
                    TlsSetValue
                    CreateFileA
                    HeapAlloc
                    GetVersion
                    InterlockedIncrement
                    VirtualAlloc
                    SetLastError
                    LeaveCriticalSection

            EXPORT
                DLL2Print
                DLL2ReturnJ

        # PEview
            IMAGE_OPTIONAL_HEADER
                IMAGE_BASE: 0x10000000

        # strings.exe (Only part of the results)
            H:mm:ss
            dddd, MMMM dd, yyyy
            M/d/yy
            December
            November
            October
            September
            August
            July
            June
            April
            March
            February
            January
            Dec
            Nov
            Oct
            Sep
            Aug
            Jul
            Jun
            May
            Apr
            Mar
            Feb
            Jan
            Saturday
            Friday
            Thursday
            Wednesday
            Tuesday
            Monday
            Sunday
            Sat
            Fri
            Thu
            Wed
            Tue
            Mon
            Sun
            SunMonTueWedThuFriSat
            JanFebMarAprMayJunJulAugSepOctNovDec
            DLL 2 mystery data %d

        # IDA Pro
            int DLL2Print()
            {
            return printf("DLL 2 mystery data %d", dword_1000B078);             // From DLLMain()
            }

            BOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
            {
            BOOL result; // eax

            result = (BOOL)CreateFileA(temp_txt, 0x40000000u, 0, 0, 2u, 0x80u, 0);
            dword_1000B078 = result;
            LOBYTE(result) = 1;
            return result;                                                      // Handle of temp.txt
            }

DLL3.dll
    PE Analysis
        # Virustotal
            19/71
            SHA-256: 2ec8e8f63f298da249268cb6ea347934d200ed75c06886f4f310f4e14d6ebecc

            PEiD packer
                Microsoft Visual C++ v6.0 DLL

            TimeStamp: 	2011-10-01 18:25:56

            Subsystem: Windows GUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	21834	24576	6.17	87f749bf719d7f135d2f67adb97f5ecf
                .rdata	28672	3008	4096	4.34	46682bd560447d0df8af83527c8a337d
                .data	32768	17580	12288	0.76	03656a08482f3415d23bbde956a88fb8
                .reloc	53248	3368	4096	3.39	44341b3f1402270668b9f53c9c75a62c

            IMPORT
                KERNEL32.DLL
                    GetLastError
                    InitializeCriticalSection
                    HeapFree
                    GetStdHandle
                    EnterCriticalSection
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    TlsAlloc
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    DeleteCriticalSection
                    GetStartupInfoA
                    GetEnvironmentStrings
                    GetCPInfo
                    InterlockedDecrement
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    GetStringTypeA
                    SetStdHandle
                    SetFilePointer
                    WideCharToMultiByte
                    TlsFree
                    GetModuleHandleA
                    WriteFile
                    GetCurrentProcess
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    GetCurrentThreadId
                    TerminateProcess
                    GetEnvironmentVariableA
                    HeapCreate
                    VirtualFree
                    TlsGetValue
                    GetFileType
                    TlsSetValue
                    HeapAlloc
                    GetVersion
                    InterlockedIncrement
                    VirtualAlloc
                    SetLastError
                    LeaveCriticalSection

            EXPORT
                DLL3GetStructure
                DLL3Print

        # PEview
            IMAGE_OPTIONAL_HEADER
                IMAGE_BASE: 0x10000000

        # strings.exe (Only part of the results)
            H:mm:ss
            dddd, MMMM dd, yyyy
            M/d/yy
            December
            November
            October
            September
            August
            July
            June
            April
            March
            February
            January
            Saturday
            Friday
            Thursday
            Wednesday
            Tuesday
            Monday
            Sunday
            SunMonTueWedThuFriSat
            JanFebMarAprMayJunJulAugSepOctNovDec
            DLL 2 mystery data %d

        # IDA Pro
            int DLL3Print()
            {
            return sub_10001087("DLL 2 mystery data %d", &WideCharStr);
            }

            BOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
            {
            BOOL result; // eax

            result = MultiByteToWideChar(0, 0, ping_www_malwareanalysisbook_com, -1, &WideCharStr, 50);              // WideCharStr = ping www.malwareanalysisbook.com
            dword_1000B0AC = (int)&WideCharStr;
            dword_1000B0A0 = 3600000;
            dword_1000B0A4 = 0;
            byte_1000B0A8 = 127;
            byte_1000B0A9 = 17;
            LOBYTE(result) = 1;
            return result;
            }

            Structure window > Insert > Add standard structure > AT_INFO        // Make time format friendly
            .text:10001022                 mov     dword_1000B0AC, offset WideCharStr
            .text:1000102C                 mov     dword_1000B0A0, 36EE80h
            .text:10001036                 mov     dword_1000B0A4, 0
            .text:10001040                 mov     byte_1000B0A8, 7Fh
            .text:10001047                 mov     byte_1000B0A9, 11h

Analysis
    The malware get Process id through DLL1Print and get file handle of temp.txt from DLL2Print.
    Then it create a scheduled job to ping www.malwareanalysisbook.com at 1:00 a.m. in random one day in a week.
    We can manual load dll file in IDA Pro at the prompt "load a file".