Lab10-02.exe
    PE Analysis
        # Virustotal
            38/70
            SHA-256: 20bf5d516f3f3ef4c9453437211486b73d519ff97d8659851012adff8e84e0a9

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2010-12-31 15:33:33

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	15430	16384	6.37	fdbad82469ad830252fe1472481c7f17
                .rdata	20480	2302	4096	3.57	c942c1ec460f76ca62fd567215629f77
                .data	24576	8008	4096	1.53	db026eca089f658d96ed8d5be712e7dd
                .rsrc	32768	3568	4096	3.12	2637c1a9ba70427ded3ad7e3daef2c5b

            IMPORT
                ADVAPI32.dll
                    CreateServiceA
                    CloseServiceHandle
                    OpenSCManagerA
                    StartServiceA
                KERNEL32.DLL
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    GetEnvironmentStringsW
                    FlushFileBuffers
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    GetCurrentProcess
                    GetEnvironmentStrings
                    GetCPInfo
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    SetStdHandle
                    WideCharToMultiByte
                    GetStringTypeA
                    SetFilePointer
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    TerminateProcess
                    SizeofResource
                    LoadResource
                    VirtualFree
                    GetFileType
                    CreateFileA
                    HeapAlloc
                    GetVersion
                    FindResourceA
                    VirtualAlloc
                    HeapCreate

        # strings.exe (Only part of the results)
            Failed to start service.
            Failed to create service.
            486 WS Driver
            Failed to open service manager.
            C:\Windows\System32\Mlwx486.sys
            c:\winddk\7600.16385.1\src\general\rootkit\wdm\sys\objfre_wxp_x86\i386\sioctl.pdb
            KeServiceDescriptorTable
            NtQueryDirectoryFile
            RtlCompareMemory
            NtQueryDirectoryFile
            MmGetSystemRoutineAddress
            RtlInitUnicodeString
            KeTickCount
            ntoskrnl.exe
            VS_VERSION_INFO
            StringFileInfo
            040904B0
            CompanyName
            Windows (R) Win 7 DDK provider
            FileDescription
            Sample IOCTL Driver
            FileVersion
            6.1.7600.16385 built by: WinDDK
            InternalName
            SIOCTL.sys
            LegalCopyright
            Microsoft Corporation. All rights reserved.
            OriginalFilename
            SIOCTL.sys
            ProductName
            Windows (R) Win 7 DDK driver
            ProductVersion
            6.1.7600.16385
            VarFileInfo
            Translation
            7"7.7V7[7b7s7

        # Resource Hacker (PE)
            FILE101.bin

    Dynamic Analysis
        # RegShot (Part of results)
            ----------------------------------
            Keys added:12
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Security
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Enum
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Security
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Enum

            ----------------------------------
            Values added:36
            ----------------------------------
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control\ActiveService: "486 WS Driver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Service: "486 WS Driver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Legacy: 0x00000001
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\0000\DeviceDesc: "486 WS Driver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_486_WS_DRIVER\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Enum\0: "Root\LEGACY_486_WS_DRIVER\0000"
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Enum\Count: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Type: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\Start: 0x00000003
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\ErrorControl: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\ImagePath: "\??\C:\Windows\System32\Mlwx486.sys"
            HKLM\SYSTEM\ControlSet001\Services\486 WS Driver\DisplayName: "486 WS Driver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Control\ActiveService: "486 WS Driver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Service: "486 WS Driver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Legacy: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\0000\DeviceDesc: "486 WS Driver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_486_WS_DRIVER\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Enum\0: "Root\LEGACY_486_WS_DRIVER\0000"
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Enum\Count: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Security\Security: 01 00 14 80 90 00 00 00 9C 00 00 00 14 00 00 00 30 00 00 00 02 00 1C 00 01 00 00 00 02 80 14 00 FF 01 0F 00 01 01 00 00 00 00 00 01 00 00 00 00 02 00 60 00 04 00 00 00 00 00 14 00 FD 01 02 00 01 01 00 00 00 00 00 05 12 00 00 00 00 00 18 00 FF 01 0F 00 01 02 00 00 00 00 00 05 20 00 00 00 20 02 00 00 00 00 14 00 8D 01 02 00 01 01 00 00 00 00 00 05 0B 00 00 00 00 00 18 00 FD 01 02 00 01 02 00 00 00 00 00 05 20 00 00 00 23 02 00 00 01 01 00 00 00 00 00 05 12 00 00 00 01 01 00 00 00 00 00 05 12 00 00 00
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Type: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\Start: 0x00000003
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\ErrorControl: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\ImagePath: "\??\C:\Windows\System32\Mlwx486.sys"
            HKLM\SYSTEM\CurrentControlSet\Services\486 WS Driver\DisplayName: "486 WS Driver"

            ----------------------------------
            Values modified:2
            ----------------------------------
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: E5 BD AE 80 D9 16 C2 8C 1C 52 08 24 1F E4 4D EF 53 D6 20 A0 DB A4 CB AC 9F C3 F5 94 99 8A 96 4A F3 1D 3E 65 86 91 ED A3 8C F4 37 EF 47 53 E5 81 D9 26 63 E0 B6 AE 81 05 F7 68 F9 15 90 4A ED 46 13 86 D6 9A 1A 21 A9 50 7F C6 5D F1 E8 52 DA B5
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 49 61 D9 E5 7C 35 AA AD 51 15 8F F9 C7 11 C2 22 F5 2A 87 F4 98 EE 84 2E EE E2 A3 F6 FE 51 1A DB 23 7E A7 C3 A2 62 2C F9 EA 91 53 FF 72 9F 3B 42 5B 21 C1 28 11 FA AF 2B 36 A9 91 7F 69 A6 7E 32 25 48 B7 35 FD B0 EA C3 4E 03 DE 0A 17 A2 B5 A0
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000005
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000006

        # procexp (View > Lower Pane View > DLLS / Handles)
            NULL

        # procmon                                                   // Lab10-01.exe does not update registry directly through comparing the results of procmon and regshot.
            Filter
                Process Name is Lab10-02.exe Include
                Path ends with sys Include
            
            Result
                2:22:13.4636701 PM	Lab10-02.exe	2916	RegSetValue	HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed	SUCCESS	Type: REG_BINARY, Length: 80, Data: 49 61 D9 E5 7C 35 AA AD 51 15 8F F9 C7 11 C2 22
                2:22:13.4622308 PM	Lab10-02.exe	2916	WriteFile	C:\WINDOWS\system32\Mlwx486.sys	SUCCESS	Offset: 0, Length: 3,456                   // Did not find this file, maybe a Rootkit

        # autoruns
            NULL

        # ApateDNS
            NULL

        # sc
            sc qc <serviceName>
                C:\Documents and Settings\practice>sc qc "486 WS Driver"
                [SC] GetServiceConfig SUCCESS

                SERVICE_NAME: 486 WS Driver
                        TYPE               : 1   KERNEL_DRIVER
                        START_TYPE         : 3   DEMAND_START
                        ERROR_CONTROL      : 1   NORMAL
                        BINARY_PATH_NAME   : \??\C:\Windows\System32\Mlwx486.sys
                        LOAD_ORDER_GROUP   :
                        TAG                : 0
                        DISPLAY_NAME       : 486 WS Driver
                        DEPENDENCIES       :
                        SERVICE_START_NAME :

            sc query <serviceName>
                C:\Documents and Settings\practice>sc query "486 WS Driver"

                SERVICE_NAME: 486 WS Driver
                        TYPE               : 1  KERNEL_DRIVER
                        STATE              : 4  RUNNING
                                                (STOPPABLE,NOT_PAUSABLE,IGNORES_SHUTDOWN)
                        WIN32_EXIT_CODE    : 0  (0x0)
                        SERVICE_EXIT_CODE  : 0  (0x0)
                        CHECKPOINT         : 0x0
                        WAIT_HINT          : 0x0        

        # IDA Pro & OllyDbg & WinDbg    (.sympath srv*c:\MyServerSymbols*https://msdl.microsoft.com/download/symbols)
            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            v3 = FindResourceA(0, (LPCSTR)0x65, Type);
            v4 = LoadResource(0, v3);
            if ( v3 )
            {
                Mlwx486sys = CreateFileA(BinaryPathName, 0xC0000000, 0, 0, 2u, 0x80u, 0);// C:\Windows\System32\Mlwx486.sys
                if ( Mlwx486sys != (HANDLE)-1 )
                {
                v6 = SizeofResource(0, v3);
                WriteFile(Mlwx486sys, v4, v6, &NumberOfBytesWritten, 0);
                CloseHandle(Mlwx486sys);
                v7 = OpenSCManagerA(0, 0, 0xF003Fu);
                if ( !v7 )
                {
                    printf(aFailedToOpenSe);
                    return 0;
                }
                s486WSDRIVER_Service = CreateServiceA(
                                        v7,
                                        DisplayName,            // 486 WS Driver
                                        DisplayName,            // 486 WS Driver
                                        0xF01FFu,
                                        1u,                     // Driver Service
                                        3u,                     // Demand Start
                                        1u,
                                        BinaryPathName,         // C:\Windows\System32\Mlwx486.sys
                                        0, 0, 0, 0, 0);
                v10 = s486WSDRIVER_Service;
                if ( !s486WSDRIVER_Service )
                {
                    printf(aFailedToCreate);
                    return 0;
                }
                if ( !StartServiceA(s486WSDRIVER_Service, 0, 0) )
                    printf(aFailedToStartS);
                CloseServiceHandle(v10);
                }
            }
            return 0;
            }

            kd> lm
            start    end        module name
            804d7000 806ee880   nt         (pdb symbols)          c:\symbols\ntoskrnl.pdb\423320282DB842E7BA2B0BFC86A84D752\ntoskrnl.pdb
            f7f52000 f7f52d80   Mlwx486    (deferred) 
            kd> lmDvmMlwx486
            Browse full module list
            start    end        module name
            f7f52000 f7f52d80   Mlwx486    (deferred)             
                Image path: Mlwx486.sys
                Image name: Mlwx486.sys
                Browse all global symbols  functions  data
                Timestamp:        Fri Dec 31 10:22:59 2010 (4D1DF553)
                CheckSum:         00003C59
                ImageSize:        00000D80
                File version:     6.1.7600.16385
                Product version:  6.1.7600.16385
                File flags:       8 (Mask 3F) Private
                File OS:          40004 NT Win32
                File type:        3.7 Driver
                File date:        00000000.00000000
                Translations:     0409.04b0
                Information from resource tables:
                    CompanyName:      Windows (R) Win 7 DDK provider
                    ProductName:      Windows (R) Win 7 DDK driver
                    InternalName:     SIOCTL.sys
                    OriginalFilename: SIOCTL.sys
                    ProductVersion:   6.1.7600.16385
                    FileVersion:      6.1.7600.16385 built by: WinDDK
                    FileDescription:  Sample IOCTL Driver
                    LegalCopyright:   Â© Microsoft Corporation. All rights reserved.
            kd> dd dwo(KeServiceDescriptorTable) L100                   // check modified value in SSDT
            ReadVirtual: 804e26a0 not properly sign extended
            804e2620  8057a521 805760c9 8058cabf 8058e3f7
            804e2630  8058d7c0 80638f82 8063b113 8063b15c
            804e2640  805745ef 80649b8b 8063873d 8058cdde
            804e2650  80630120 80577310 80591595 8062702f
            804e2660  8059df59 80569302 805d7867 805a1387
            804e2670  804e2c2c 80649b77 805c99ad 804ec61c
            804e2680  805699ae f4f33f00 8058d24c 8064f9c0
            804e2690  8058b776 8057ac9b 8064fc2d 8058cb11
            804e26a0  804e1f6a 8065b0f6 805a174f 8057013a
            804e26b0  8064a1dc 8056f980 8058e635 805aa070
            804e26c0  806305cb f4f33c50 805d7758 805776e0
            804e26d0  805874b1 805c2cdb 805dc20a 805b02e9
            804e26e0  805830e4 8064a7fd 80565433 8057d6a5
            804e26f0  8059e796 80578925 805dcc22 805a7a24
            804e2700  805d9ad6 8065c271 8065c3cb 80566590
            804e2710  8058bef5 80649b77 805d610b f4f33a90
            804e2720  8063b1b7 f4f33af0 805796db 805c5e6b
            804e2730  805749da 8058081b 80649b8b f4f339a0
            804e2740  80649b63 f4f338d0 80625e50 805afad0
            804e2750  805961e0 8058c894 8056e7aa f4f33a10
            804e2760  805960e1 80627893 806273e4 80569c2d
            804e2770  805771f8 805e056b 8062c893 8059f056
            804e2780  8053b86d 805dc22e 8058b1e2 805817c1
            804e2790  805a6f30 8062c65f 8063047f 8062c87a
            804e27a0  805a95b1 805a29bd f4f340d0 805adaf8
            804e27b0  8059095c 805afca0 805d0d8f 805af122
            804e27c0  8059ebe3 8059eb60 8062651b 806269ef
            804e27d0  8057cb31 80649b77 80591d22 80591a6b
            804e27e0  80591b34 8057b28f 80581b30 8064a2cd
            804e27f0  8056f91b 80616e9f 80630823 f4f33eb0
            804e2800  8057778e 80595ba5 80574bc1 80571121
            804e2810  8057131a 8056e583 805daca3 8057b15b
            ReadVirtual: 804e2820 not properly sign extended
            804e2820  80590cfc 80570bbe 80570b2f 8064a103
            804e2830  8059be7a 8059abdc 80596c0c 8059ddc8
            804e2840  805a96f4 80574f70 805d9a2e 805707ea
            804e2850  80649b8b 80649b8b 804f97c5 80566d02
            804e2860  80581f1f f7f52486 80587913 806170e8                   //f7f52000 - f7f52d80
            804e2870  8057b30c 8058004a 805d57e8 8057bc38
            804e2880  80583d25 80623917 80570d5c 8056731e
            804e2890  8057188b 80581c74 8064acaf 80616f60
            804e28a0  f4f33450 8064f3a3 8064a636 8058292c
            804e28b0  8064f5ad 80567672 806179a9 80580d06
            804e28c0  80596aac 8064942f 8057afcc 80649bb3
            804e28d0  80649b50 8057f473 8058dc42 8058e90d
            804e28e0  80587579 f4f335c0 80571418 8056fbc3
            804e28f0  8058e352 804e1fb2 8064916b 8057044f
            804e2900  805da060 8058b527 805814b2 80579072
            804e2910  805665fb 8058ba06 80567119 8065c346
            804e2920  8064f822 8065017e 80580514 8056bd3c
            804e2930  8056b854 806239f6 8062c807 80596862
            804e2940  8056dd9e 8062c600 805dd720 8053bd02
            804e2950  8064fd15 806300c0 80578f98 8064fe16
            804e2960  8064ff01 8065002e 80579c0a 80649b8b
            804e2970  80649b8b 8062e94f 8065de8e 805b21fb
            804e2980  805ad7b7 805ad75e 80617635 805699fd
            804e2990  8056ca46 8064a5c1 8064a4e5 8065bce7
            804e29a0  8057e4da 805aa1c4 8064ef06 80581ba6
            804e29b0  80570e2d 8056c62e 805a75bc 8064a7db
            804e29c0  8056c4e3 8062f1a3 8064a557 8064a473
            804e29d0  80617981 80598227 80649e50 80649b50
            804e29e0  805a6aa9 8066878b 80648ab3 805e02da
            804e29f0  804e570b 805e0960 805a98db f4f33730
            804e2a00  80617ec3 806481ff 80517369 8064aa44
            804e2a10  8064abfd 80630065 805e05d6 8064ad5d
            kd> u f7f52486
            ReadVirtual: f7e8d486 not properly sign extended
            f7e8d486 8bff            mov     edi,edi
            f7e8d488 55              push    ebp
            f7e8d489 8bec            mov     ebp,esp
            f7e8d48b 56              push    esi
            f7e8d48c 8b751c          mov     esi,dword ptr [ebp+1Ch]
            f7e8d48f 57              push    edi
            f7e8d490 ff7530          push    dword ptr [ebp+30h]
            f7e8d493 ff752c          push    dword ptr [ebp+2Ch]

            restore vm to clean state

            kd> dd dwo(KeServiceDescriptorTable) L100
            ReadVirtual: 804e2620 not properly sign extended
            804e2620  8057a521 805760c9 8058cabf 8058e3f7
            804e2630  8058d7c0 80638f82 8063b113 8063b15c
            804e2640  805745ef 80649b8b 8063873d 8058cdde
            804e2650  80630120 80577310 80591595 8062702f
            804e2660  8059df59 80569302 805d7867 805a1387
            804e2670  804e2c2c 80649b77 805c99ad 804ec61c
            804e2680  805699ae f4f33f00 8058d24c 8064f9c0
            804e2690  8058b776 8057ac9b 8064fc2d 8058cb11
            804e26a0  804e1f6a 8065b0f6 805a174f 8057013a
            804e26b0  8064a1dc 8056f980 8058e635 805aa070
            804e26c0  806305cb f4f33c50 805d7758 805776e0
            804e26d0  805874b1 805c2cdb 805dc20a 805b02e9
            804e26e0  805830e4 8064a7fd 80565433 8057d6a5
            804e26f0  8059e796 80578925 805dcc22 805a7a24
            804e2700  805d9ad6 8065c271 8065c3cb 80566590
            804e2710  8058bef5 80649b77 805d610b f4f33a90
            804e2720  8063b1b7 f4f33af0 805796db 805c5e6b
            804e2730  805749da 8058081b 80649b8b f4f339a0
            804e2740  80649b63 f4f338d0 80625e50 805afad0
            804e2750  805961e0 8058c894 8056e7aa f4f33a10
            804e2760  805960e1 80627893 806273e4 80569c2d
            804e2770  805771f8 805e056b 8062c893 8059f056
            804e2780  8053b86d 805dc22e 8058b1e2 805817c1
            804e2790  805a6f30 8062c65f 8063047f 8062c87a
            804e27a0  805a95b1 805a29bd f4f340d0 805adaf8
            804e27b0  8059095c 805afca0 805d0d8f 805af122
            804e27c0  8059ebe3 8059eb60 8062651b 806269ef
            804e27d0  8057cb31 80649b77 80591d22 80591a6b
            804e27e0  80591b34 8057b28f 80581b30 8064a2cd
            804e27f0  8056f91b 80616e9f 80630823 f4f33eb0
            804e2800  8057778e 80595ba5 80574bc1 80571121
            804e2810  8057131a 8056e583 805daca3 8057b15b
            ReadVirtual: 804e2820 not properly sign extended
            804e2820  80590cfc 80570bbe 80570b2f 8064a103
            804e2830  8059be7a 8059abdc 80596c0c 8059ddc8
            804e2840  805a96f4 80574f70 805d9a2e 805707ea
            804e2850  80649b8b 80649b8b 804f97c5 80566d02
            804e2860  80581f1f 8057d37b 80587913 806170e8                       // !
            804e2870  8057b30c 8058004a 805d57e8 8057bc38
            804e2880  80583d25 80623917 80570d5c 8056731e
            804e2890  8057188b 80581c74 8064acaf 80616f60
            804e28a0  f4f33450 8064f3a3 8064a636 8058292c
            804e28b0  8064f5ad 80567672 806179a9 80580d06
            804e28c0  80596aac 8064942f 8057afcc 80649bb3
            804e28d0  80649b50 8057f473 8058dc42 8058e90d
            804e28e0  80587579 f4f335c0 80571418 8056fbc3
            804e28f0  8058e352 804e1fb2 8064916b 8057044f
            804e2900  805da060 8058b527 805814b2 80579072
            804e2910  805665fb 8058ba06 80567119 8065c346
            804e2920  8064f822 8065017e 80580514 8056bd3c
            804e2930  8056b854 806239f6 8062c807 80596862
            804e2940  8056dd9e 8062c600 805dd720 8053bd02
            804e2950  8064fd15 806300c0 80578f98 8064fe16
            804e2960  8064ff01 8065002e 80579c0a 80649b8b
            804e2970  80649b8b 8062e94f 8065de8e 805b21fb
            804e2980  805ad7b7 805ad75e 80617635 805699fd
            804e2990  8056ca46 8064a5c1 8064a4e5 8065bce7
            804e29a0  8057e4da 805aa1c4 8064ef06 80581ba6
            804e29b0  80570e2d 8056c62e 805a75bc 8064a7db
            804e29c0  8056c4e3 8062f1a3 8064a557 8064a473
            804e29d0  80617981 80598227 80649e50 80649b50
            804e29e0  805a6aa9 8066878b 80648ab3 805e02da
            804e29f0  804e570b 805e0960 805a98db f4f33730
            804e2a00  80617ec3 806481ff 80517369 8064aa44
            804e2a10  8064abfd 80630065 805e05d6 8064ad5d
            kd> u 8057d37b
            ReadVirtual: 8057d37b not properly sign extended                // Due to symbol problem, here should display nt!NtQueryDirectoryFile
            8057d37b 8bff            mov     edi,edi
            8057d37d 55              push    ebp
            8057d37e 8bec            mov     ebp,esp
            8057d380 8d452c          lea     eax,[ebp+2Ch]
            8057d383 50              push    eax
            8057d384 8d4528          lea     eax,[ebp+28h]
            8057d387 50              push    eax
            8057d388 8d4524          lea     eax,[ebp+24h]

            run the Lab10-02.exe

            kd> dd dwo(KeServiceDescriptorTable) L100
            // Find the modified address

            - just bp
                kd> bp f7eb3486
                kd> g                                                       // open window explorer
                Break instruction exception - code 80000003 (first chance)
                Mlwx486+0x486:
                f7eb3486 8bff            mov     edi,edi
                f7eb3486 8bff            mov     edi,edi
                f7eb3488 55              push    ebp
                f7eb3489 8bec            mov     ebp,esp
                f7eb348b 56              push    esi
                f7eb348c 8b751c          mov     esi,dword ptr [ebp+1Ch]
                f7eb348f 57              push    edi
                f7eb3490 ff7530          push    dword ptr [ebp+30h] = 0
                f7eb3493 ff752c          push    dword ptr [ebp+2Ch] = ec db f8 20
                f7eb3496 ff7528          push    dword ptr [ebp+28h] = 1
                f7eb3499 ff7524          push    dword ptr [ebp+24h] = 3
                f7eb349c ff7520          push    dword ptr [ebp+20h] = 68 2
                f7eb349f 56              push    esi                 = 04dc8f02
                f7eb34a0 ff7518          push    dword ptr [ebp+18h] = 4d bd f8 20
                f7eb34a3 ff7514          push    dword ptr [ebp+14h] = 0
                f7eb34a6 ff7510          push    dword ptr [ebp+10h] = 0
                f7eb34a9 ff750c          push    dword ptr [ebp+0Ch] = 0
                f7eb34ac ff7508          push    dword ptr [ebp+8]   = d4 3
                f7eb34af e860000000      call    Mlwx486+0x514 (f7eb3514)

                IDA sub_10486 in FILE101.sys
                    .text:00010486                 mov     edi, edi
                    .text:00010488                 push    ebp
                    .text:00010489                 mov     ebp, esp
                    .text:0001048B                 push    esi
                    .text:0001048C                 mov     esi, [ebp+FileInformation]
                    .text:0001048F                 push    edi
                    .text:00010490                 push    dword ptr [ebp+RestartScan] ; RestartScan
                    .text:00010493                 push    [ebp+FileName]  ; FileName
                    .text:00010496                 push    dword ptr [ebp+ReturnSingleEntry] ; ReturnSingleEntry
                    .text:00010499                 push    [ebp+FileInformationClass] ; FileInformationClass
                    .text:0001049C                 push    [ebp+Length]    ; Length
                    .text:0001049F                 push    esi             ; FileInformation
                    .text:000104A0                 push    [ebp+IoStatusBlock] ; IoStatusBlock
                    .text:000104A3                 push    [ebp+ApcContext] ; ApcContext
                    .text:000104A6                 push    [ebp+ApcRoutine] ; ApcRoutine
                    .text:000104A9                 push    [ebp+Event]     ; Event
                    .text:000104AC                 push    [ebp+FileHandle] ; FileHandle
                    .text:000104AF                 call    NtQueryDirectoryFile

                kd> r ebp
                ebp=f5691d30
                kd> dc f5691d30+30
                f5691d60  00000000 028fde70 7c90e514 badb0d00  ....p......|....
                f5691d70  028fdb6c 00000000 00000000 00000000  l...............
                f5691d80  00000000 00000000 00000000 00000000  ................
                f5691d90  00000000 00000000 00000023 00000023  ........#...#...
                f5691da0  00090608 0000001e 00002050 00000001  ........P ......
                f5691db0  ffffffff 0000003b 00000000 7c90d59e  ....;..........|
                f5691dc0  00004021 028fde70 00000000 7c90e514  !@..p..........|
                f5691dd0  0000001b 00000246 028fdb64 00000023  ....F...d...#...
                kd> dc f5691d30+2c
                f5691d5c  028fdbec 00000000 028fde70 7c90e514  ........p......|
                f5691d6c  badb0d00 028fdb6c 00000000 00000000  ....l...........
                f5691d7c  00000000 00000000 00000000 00000000  ................
                f5691d8c  00000000 00000000 00000000 00000023  ............#...
                f5691d9c  00000023 00090608 0000001e 00002050  #...........P ..
                f5691dac  00000001 ffffffff 0000003b 00000000  ........;.......
                f5691dbc  7c90d59e 00004021 028fde70 00000000  ...|!@..p.......
                f5691dcc  7c90e514 0000001b 00000246 028fdb64  ...|....F...d...
                kd> dc f5691d30+28
                f5691d58  00000001 028fdbec 00000000 028fde70  ............p...
                f5691d68  7c90e514 badb0d00 028fdb6c 00000000  ...|....l.......
                f5691d78  00000000 00000000 00000000 00000000  ................
                f5691d88  00000000 00000000 00000000 00000000  ................
                f5691d98  00000023 00000023 00090608 0000001e  #...#...........
                f5691da8  00002050 00000001 ffffffff 0000003b  P ..........;...
                f5691db8  00000000 7c90d59e 00004021 028fde70  .......|!@..p...
                f5691dc8  00000000 7c90e514 0000001b 00000246  .......|....F...
                kd> dc f5691d30+24
                f5691d54  00000003 00000001 028fdbec 00000000  ................
                f5691d64  028fde70 7c90e514 badb0d00 028fdb6c  p......|....l...
                f5691d74  00000000 00000000 00000000 00000000  ................
                f5691d84  00000000 00000000 00000000 00000000  ................
                f5691d94  00000000 00000023 00000023 00090608  ....#...#.......
                f5691da4  0000001e 00002050 00000001 ffffffff  ....P ..........
                f5691db4  0000003b 00000000 7c90d59e 00004021  ;..........|!@..
                f5691dc4  028fde70 00000000 7c90e514 0000001b  p..........|....
                kd> dc f5691d30+20
                f5691d50  00000268 00000003 00000001 028fdbec  h...............
                f5691d60  00000000 028fde70 7c90e514 badb0d00  ....p......|....
                f5691d70  028fdb6c 00000000 00000000 00000000  l...............
                f5691d80  00000000 00000000 00000000 00000000  ................
                f5691d90  00000000 00000000 00000023 00000023  ........#...#...
                f5691da0  00090608 0000001e 00002050 00000001  ........P ......
                f5691db0  ffffffff 0000003b 00000000 7c90d59e  ....;..........|
                f5691dc0  00004021 028fde70 00000000 7c90e514  !@..p..........|
                kd> r esi
                esi=028fdc04
                kd> dc f5691d30+18
                ReadVirtual: f5691d48 not properly sign extended
                f5691d48  028fdbd4 028fdc04 00000268 00000003  ........h.......
                f5691d58  00000001 028fdbec 00000000 028fde70  ............p...
                f5691d68  7c90e514 badb0d00 028fdb6c 00000000  ...|....l.......
                f5691d78  00000000 00000000 00000000 00000000  ................
                f5691d88  00000000 00000000 00000000 00000000  ................
                f5691d98  00000023 00000023 00090608 0000001e  #...#...........
                f5691da8  00002050 00000001 ffffffff 0000003b  P ..........;...
                f5691db8  00000000 7c90d59e 00004021 028fde70  .......|!@..p...
                kd> dc f5691d30+14
                ReadVirtual: f5691d44 not properly sign extended
                f5691d44  00000000 028fdbd4 028fdc04 00000268  ............h...
                f5691d54  00000003 00000001 028fdbec 00000000  ................
                f5691d64  028fde70 7c90e514 badb0d00 028fdb6c  p......|....l...
                f5691d74  00000000 00000000 00000000 00000000  ................
                f5691d84  00000000 00000000 00000000 00000000  ................
                f5691d94  00000000 00000023 00000023 00090608  ....#...#.......
                f5691da4  0000001e 00002050 00000001 ffffffff  ....P ..........
                f5691db4  0000003b 00000000 7c90d59e 00004021  ;..........|!@..
                kd> dc f5691d30+10
                ReadVirtual: f5691d40 not properly sign extended
                f5691d40  00000000 00000000 028fdbd4 028fdc04  ................
                f5691d50  00000268 00000003 00000001 028fdbec  h...............
                f5691d60  00000000 028fde70 7c90e514 badb0d00  ....p......|....
                f5691d70  028fdb6c 00000000 00000000 00000000  l...............
                f5691d80  00000000 00000000 00000000 00000000  ................
                f5691d90  00000000 00000000 00000023 00000023  ........#...#...
                f5691da0  00090608 0000001e 00002050 00000001  ........P ......
                f5691db0  ffffffff 0000003b 00000000 7c90d59e  ....;..........|
                kd> dc f5691d30+0c
                ReadVirtual: f5691d3c not properly sign extended
                f5691d3c  00000000 00000000 00000000 028fdbd4  ................
                f5691d4c  028fdc04 00000268 00000003 00000001  ....h...........
                f5691d5c  028fdbec 00000000 028fde70 7c90e514  ........p......|
                f5691d6c  badb0d00 028fdb6c 00000000 00000000  ....l...........
                f5691d7c  00000000 00000000 00000000 00000000  ................
                f5691d8c  00000000 00000000 00000000 00000023  ............#...
                f5691d9c  00000023 00090608 0000001e 00002050  #...........P ..
                f5691dac  00000001 ffffffff 0000003b 00000000  ........;.......
                kd> dc f5691d30+8
                ReadVirtual: f5691d38 not properly sign extended
                f5691d38  000003d4 00000000 00000000 00000000  ................
                f5691d48  028fdbd4 028fdc04 00000268 00000003  ........h.......
                f5691d58  00000001 028fdbec 00000000 028fde70  ............p...
                f5691d68  7c90e514 badb0d00 028fdb6c 00000000  ...|....l.......
                f5691d78  00000000 00000000 00000000 00000000  ................
                f5691d88  00000000 00000000 00000000 00000000  ................
                f5691d98  00000023 00000023 00090608 0000001e  #...#...........
                f5691da8  00002050 00000001 ffffffff 0000003b  P ..........;...

                NTSTATUS ZwQueryDirectoryFile(
                _In_     HANDLE                 FileHandle,
                _In_opt_ HANDLE                 Event = 0,
                _In_opt_ PIO_APC_ROUTINE        ApcRoutine = 0,
                _In_opt_ PVOID                  ApcContext = 0,
                _Out_    PIO_STATUS_BLOCK       IoStatusBlock,
                _Out_    PVOID                  FileInformation,
                _In_     ULONG                  Length,
                _In_     FILE_INFORMATION_CLASS FileInformationClass = 3,
                _In_     BOOLEAN                ReturnSingleEntry = 1,
                _In_opt_ PUNICODE_STRING        FileName,
                _In_     BOOLEAN                RestartScan = 0
                );

                kd> t                                                                                   // Step into
                Mlwx486+0x514:
                f7eb3514 ff258035ebf7    jmp     dword ptr [Mlwx486+0x580 (f7eb3580)]                   // Step into the value stored in 0xf7eb3580
                kd> dc f7eb3580
                f7eb3580  8057d37b 805c831e 804d92a7 80552180  {.W...\...M..!U.                         // 8057d37b
                f7eb3590  804dab8a 00000000 00000000 00000000  ..M.............
                f7eb35a0  00000000 4d1df553 00000000 00000002  ....S..M........
                f7eb35b0  0000006a 000005bc 000005bc 53445352  j...........RSDS
                f7eb35c0  86753396 4dc50f62 3671f389 66667bec  .3u.b..M..q6.{ff
                f7eb35d0  00000049 775c3a63 64646e69 36375c6b  I...c:\winddk\76
                f7eb35e0  312e3030 35383336 735c312e 675c6372  00.16385.1\src\g
                f7eb35f0  72656e65 725c6c61 6b746f6f 775c7469  eneral\rootkit\w
                kd> p
                nt!NtQueryDirectoryFile:
                8057d37b 8bff            mov     edi,edi                                                // 8057d37b
                ...
                nt!NtQueryDirectoryFile+0x5e:
                8057d3d9 c22c00          ret     2Ch
                kd> p
                Mlwx486+0x4b4:
                f7eb34b4 33ff            xor     edi,edi
                ...
                kd> p
                Mlwx486+0x4c7:
                f7eb34c7 753c            jne     Mlwx486+0x505 (f7eb3505)
                kd> p
                Mlwx486+0x505:
                f7eb3505 8b4530          mov     eax,dword ptr [ebp+30h]                                // RestartScan              This will not goto main body.

            .text:00010490                 push    dword ptr [ebp+RestartScan] ; RestartScan
            .text:00010493                 push    [ebp+FileName]  ; FileName
            .text:00010496                 push    dword ptr [ebp+ReturnSingleEntry] ; ReturnSingleEntry            // need to control this param [ebp+28h]
            .text:00010499                 push    [ebp+FileInformationClass] ; FileInformationClass
            .text:0001049C                 push    [ebp+Length]    ; Length
            .text:0001049F                 push    esi             ; FileInformation
            .text:000104A0                 push    [ebp+IoStatusBlock] ; IoStatusBlock
            .text:000104A3                 push    [ebp+ApcContext] ; ApcContext
            .text:000104A6                 push    [ebp+ApcRoutine] ; ApcRoutine
            .text:000104A9                 push    [ebp+Event]     ; Event
            .text:000104AC                 push    [ebp+FileHandle] ; FileHandle
            .text:000104AF                 call    NtQueryDirectoryFile

            - bp with condition
                kd> bp f7f48486 ".if dwo(esp+0x24)==0 {} .else {gc}"                                        // esp@NtQueryDirectoryFile + 0x24
                kd> g                                                                                       // close all window explorers; cd C:\WINDOWS\system32; dir
                ...
                kd> p
                Mlwx486+0x4c9:
                f7e294c9 53              push    ebx
                kd> p
                Mlwx486+0x4ca:
                f7e294ca 6a08            push    8
                kd> p
                Mlwx486+0x4cc:
                f7e294cc 681a95e2f7      push    offset Mlwx486+0x51a (f7e2951a)
                kd> dc f7e2951a
                ReadVirtual: f7e2951a not properly sign extended
                f7e2951a  006c004d 00780077 00000000 00000000  M.l.w.x.........
                f7e2952a  00000000 00000000 00000000 00000000  ................
                f7e2953a  00000000 00000000 00000000 00000000  ................
                f7e2954a  00000000 00000000 00000000 00000000  ................
                f7e2955a  00000000 00000000 00000000 00000000  ................
                f7e2956a  00000000 00000000 00000000 00000000  ................
                f7e2957a  00000000 d37b0000 831e8057 92a7805c  ......{.W...\...
                f7e2958a  2180804d ab8a8055 0000804d 00000000  M..!U...M.......
                ...
                kd> p
                Mlwx486+0x4d7:
                f7e294d7 ff159095e2f7    call    dword ptr [Mlwx486+0x590 (f7e29590)]                       // RtlCompareMemory
                kd> dc f7e29590
                ReadVirtual: f7e29590 not properly sign extended
                f7e29590  804dab8a 00000000 00000000 00000000  ..M.............
                f7e295a0  00000000 4d1df553 00000000 00000002  ....S..M........
                f7e295b0  0000006a 000005bc 000005bc 53445352  j...........RSDS
                f7e295c0  86753396 4dc50f62 3671f389 66667bec  .3u.b..M..q6.{ff
                f7e295d0  00000049 775c3a63 64646e69 36375c6b  I...c:\winddk\76
                f7e295e0  312e3030 35383336 735c312e 675c6372  00.16385.1\src\g
                f7e295f0  72656e65 725c6c61 6b746f6f 775c7469  eneral\rootkit\w
                f7e29600  735c6d64 6f5c7379 72666a62 78775f65  dm\sys\objfre_wx
                kd> u 804dab8a
                ReadVirtual: 804dab8a not properly sign extended
                804dab8a 56              push    esi
                804dab8b 57              push    edi
                804dab8c fc              cld
                804dab8d 8b74240c        mov     esi,dword ptr [esp+0Ch]
                804dab91 8b7c2410        mov     edi,dword ptr [esp+10h]
                804dab95 8b4c2414        mov     ecx,dword ptr [esp+14h]
                804dab99 c1e902          shr     ecx,2
                804dab9c 7404            je      nt!RtlCompareMemory+0x18 (804daba2)

                .text:000104CA                 push    8               ; Length
                .text:000104CC                 push    offset word_1051A ; Source2
                .text:000104D1                 lea     eax, [esi+5Eh]
                .text:000104D4                 push    eax             ; Source1
                .text:000104D5                 xor     bl, bl
                .text:000104D7                 call    ds:RtlCompareMemory

                kd> dc eax
                00160b66  004e0046 00430054 00430041 00450048  F.N.T.C.A.C.H.E.                     // find Mlws* file and hide it.
                00160b76  0044002e 00540041 00780000 00000000  ..D.A.T...x.....
                00160b86  38000000 9e1eaedd 4a9001c8 190ca6ef  ...8.......J....
                00160b96  380001d6 9e1eaedd e3a001c8 18d12864  ...8........d(..
                00160ba6  d80001d6 00000005 e0000000 00000005  ................
                00160bb6  00200000 00160000 00000000 00000000  .. .............
                00160bc6  00000000 00000000 00000000 00000000  ................
                00160bd6  00000000 00000000 006f0066 0074006e  ........f.o.n.t.

                while ( 1 )
                    {
                    v14 = 0;
                    if ( RtlCompareMemory((char *)v11 + 94, &word_1051A, 8u) == 8 )
                    {
                        v14 = 1;                                                                    // offset the structure to hide file
                        if ( v13 )
                        {
                        if ( *v11 )
                            *v13 += *v11;
                        else
                            *v13 = 0;
                        }
                    }
                    if ( !*v11 )
                        break;
                    if ( !v14 )
                        v13 = v11;
                    v11 = (_DWORD *)((char *)v11 + *v11);
                    }

FILE101.bin
    PE Analysis
        # Virustotal
            0/71
            SHA-256: 42b66f4dcb1380ab6330cfb638ce97c7bea6d772eddd1d34c1031b0d16dea19c
            SIOCTL.sys

            TimeStamp: 2010-12-31 15:22:59
            
            File is not signed
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	1152	164	256	4.12	19a584caecb342dc1302b0bf69d94b62
                .rdata	1408	166	256	3.63	8a18f0623c992529c4c1dc6da6dc45a3
                .data	1664	20	128	0.52	1f558917e0b83de44fffa4db41aab932
                INIT	1792	468	512	4.95	eb5f3ff826765be32b5f9fe604045462
                .rsrc	2304	1000	1024	3.39	1bc9aadd1fbb8f6eb8fd8a4161a88e01

        # strings.exe (Only part of the results)
            c:\winddk\7600.16385.1\src\general\rootkit\wdm\sys\objfre_wxp_x86\i386\sioctl.pdb
            98t
            KeServiceDescriptorTable
            NtQueryDirectoryFile
            RtlCompareMemory
            NtQueryDirectoryFile
            MmGetSystemRoutineAddress
            RtlInitUnicodeString
            KeTickCount
            ntoskrnl.exe
            VS_VERSION_INFO
            StringFileInfo
            040904B0
            CompanyName
            Windows (R) Win 7 DDK provider
            FileDescription
            Sample IOCTL Driver
            FileVersion
            6.1.7600.16385 built by: WinDDK
            InternalName
            SIOCTL.sys
            LegalCopyright
            Microsoft Corporation. All rights reserved.
            OriginalFilename
            SIOCTL.sys
            ProductName
            Windows (R) Win 7 DDK driver
            ProductVersion
            6.1.7600.16385
            VarFileInfo
            Translation
            7"7.7V7[7b7s7

        # Resource Hacker
            Nothing valuable

Analysis
    This malware lease a .sys file from .rsrc section and then move it under C:\WINDOWS\system32 directory. After that it hook the nt!NtQueryDirectoryFile and modify the result of the function to hide from explorer. So, we cannot find it through file explorer or dir command. To delete this malware, we can disable driver service and restart vm, then we can see the malware in the \system32\.
