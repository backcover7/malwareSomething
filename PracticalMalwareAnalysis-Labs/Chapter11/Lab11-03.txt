Lab11-03.exe
    PE Analysis
        # Virustotal
            28/67
            SHA-256: bf023ff344efe2db0e0a963869368f0ef352764666bc368ad61b7a4c1d9f5975
            Keylogger.exe

            PEiD packer
                Armadillo v1.71

            TimeStamp: 2011-11-19 16:34:41

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	25170	28672	6.16	d8acab16afeb7f0fc273d55005f9da9c
                .rdata	32768	2670	4096	4.06	98ac0129787cafc7aa0b3a43e2ea2207
                .data	36864	16348	12288	0.86	030b2e8fcd56f03cdcf6a84bbf91c56f

            IMPORT
                KERNEL32.dll
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetFileAttributesA
                    WaitForSingleObject
                    GetExitCodeProcess
                    LCMapStringA
                    CopyFileA
                    ExitProcess
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    GetCurrentProcess
                    GetEnvironmentStrings
                    GetFileSize
                    GetCPInfo
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    GetFileType
                    SetStdHandle
                    SetFilePointer
                    WideCharToMultiByte
                    MapViewOfFile
                    GetStringTypeA
                    GetModuleHandleA
                    CompareStringW
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    CreateFileMappingA
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    SetEnvironmentVariableA
                    GetOEMCP
                    TerminateProcess
                    CreateProcessA
                    GetEnvironmentVariableA
                    UnmapViewOfFile
                    VirtualFree
                    HeapDestroy
                    IsBadReadPtr
                    CreateFileA
                    HeapAlloc
                    GetVersion
                    VirtualAlloc
                    HeapCreate
                    CompareStringA

        # strings.exe (Only part of the results)
            xV4
            C:\WINDOWS\System32\inet_epar32.dll
            zzz69806582
            .text
            net start cisvc
            C:\WINDOWS\System32\%s
            cisvc.exe
            Lab11-03.dll
            C:\WINDOWS\System32\inet_epar32.dll

    Dynamic Analysis
        C:\Documents and Settings\practice\Desktop>Lab11-03.exe
        The Indexing Service service is starting.
        The Indexing Service service was started successfully.

        # RegShot (Part of results)
            ----------------------------------
            Keys added:19
            ----------------------------------
            HKLM\SOFTWARE\Classes\.xml\PersistentHandler
            HKLM\SOFTWARE\Classes\.xsl\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{0CD7A5C0-9F37-11CE-AE65-08002B2E1262}\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{25336920-03F9-11cf-8FD0-00AA00686F13}\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{3050f4d8-98B5-11CF-BB82-00AA00BDCE0B}\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{48123BC4-99D9-11D1-A6B3-00C04FD91555}\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\PersistentHandler
            HKLM\SOFTWARE\Classes\CLSID\{FBF23B40-E3F0-101B-8488-00AA003E56F8}\PersistentHandler
            HKLM\SOFTWARE\Classes\.xbm
            HKLM\SOFTWARE\Classes\.xbm\PersistentHandler
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Control
            HKLM\SYSTEM\ControlSet001\Services\CiSvc\Enum
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Control
            HKLM\SYSTEM\CurrentControlSet\Services\CiSvc\Enum
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Notepad

            ----------------------------------
            Values added:34
            ----------------------------------
            HKLM\SOFTWARE\Classes\.xml\PersistentHandler\: "{5e941d80-bf96-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\.xsl\PersistentHandler\: "{5e941d80-bf96-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\CLSID\{0CD7A5C0-9F37-11CE-AE65-08002B2E1262}\PersistentHandler\: "{098f2470-bae0-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\CLSID\{25336920-03F9-11cf-8FD0-00AA00686F13}\PersistentHandler\: "{eec97550-47a9-11cf-b952-00aa0051fe20}"
            HKLM\SOFTWARE\Classes\CLSID\{3050f4d8-98B5-11CF-BB82-00AA00BDCE0B}\PersistentHandler\: "{eec97550-47a9-11cf-b952-00aa0051fe20}"
            HKLM\SOFTWARE\Classes\CLSID\{48123BC4-99D9-11D1-A6B3-00C04FD91555}\PersistentHandler\: "{5e941d80-bf96-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\CLSID\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\PersistentHandler\: "{098f2470-bae0-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\CLSID\{FBF23B40-E3F0-101B-8488-00AA003E56F8}\PersistentHandler\: "{5e941d80-bf96-11cd-b579-08002b30bfeb}"
            HKLM\SOFTWARE\Classes\.xbm\PersistentHandler\: "{098f2470-bae0-11cd-b579-08002b30bfeb}"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Control\ActiveService: "CiSvc"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Service: "CiSvc"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Legacy: 0x00000001
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\0000\DeviceDesc: "Indexing Service"
            HKLM\SYSTEM\ControlSet001\Enum\Root\LEGACY_CISVC\NextInstance: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\CiSvc\Enum\0: "Root\LEGACY_CISVC\0000"
            HKLM\SYSTEM\ControlSet001\Services\CiSvc\Enum\Count: 0x00000001
            HKLM\SYSTEM\ControlSet001\Services\CiSvc\Enum\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Control\*NewlyCreated*: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Control\ActiveService: "CiSvc"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Service: "CiSvc"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Legacy: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\ConfigFlags: 0x00000000
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\Class: "LegacyDriver"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\ClassGUID: "{8ECC055D-047F-11D1-A537-0000F8753ED1}"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\0000\DeviceDesc: "Indexing Service"
            HKLM\SYSTEM\CurrentControlSet\Enum\Root\LEGACY_CISVC\NextInstance: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\CiSvc\Enum\0: "Root\LEGACY_CISVC\0000"
            HKLM\SYSTEM\CurrentControlSet\Services\CiSvc\Enum\Count: 0x00000001
            HKLM\SYSTEM\CurrentControlSet\Services\CiSvc\Enum\NextInstance: 0x00000001
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU\d: "notepad\1"

            ----------------------------------
            Values modified:7
            ----------------------------------
            HKLM\SOFTWARE\Classes\Microsoft Internet Mail Message\: "Outlook Express Mail Message"
            HKLM\SOFTWARE\Classes\Microsoft Internet Mail Message\: "Internet E-Mail Message"
            HKLM\SOFTWARE\Classes\Microsoft Internet News Message\: "Outlook Express News Message"
            HKLM\SOFTWARE\Classes\Microsoft Internet News Message\: "Internet News Message"
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 9F 8C BE 0E D1 BE A2 65 E0 B1 40 80 6C 34 FA BA D3 A4 CA 0F 86 CB 80 EE A2 DA 09 BE AB C7 2B 7C B6 9C 43 E8 43 0C EE 0F A8 E0 D1 92 1B F9 0F 31 D6 56 AF 0B 92 B9 0C CA E9 5F 93 12 C6 61 B6 8F 06 01 29 9E E4 60 3B F2 DD EF 97 99 44 D1 E9 20
            HKLM\SOFTWARE\Microsoft\Cryptography\RNG\Seed: 0A E5 8B 68 57 A1 CA E8 75 F7 64 D7 24 AA 63 DD 54 10 45 1A B7 84 04 68 5E CC 88 8C 38 48 B1 FB FD 3A 74 C6 0E 60 C1 08 60 B7 BE CC BF 1A FB 7C 56 71 8D AA 40 F9 AC EE CE 27 5A 7E D8 AD 6C AE EF A0 DC BB F2 60 05 11 0C D9 87 5E 39 1F 26 69
            HKLM\SYSTEM\ControlSet001\Control\ServiceCurrent\: 0x0000000D
            HKLM\SYSTEM\ControlSet001\Control\ServiceCurrent\: 0x0000000E
            HKLM\SYSTEM\CurrentControlSet\Control\ServiceCurrent\: 0x0000000D
            HKLM\SYSTEM\CurrentControlSet\Control\ServiceCurrent\: 0x0000000E
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU\MRUList: "cba"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU\MRUList: "dcba"
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000003
            HKU\S-1-5-21-1078081533-842925246-1708537768-1003\SessionInformation\ProgramCount: 0x00000004            

        # procexp (View > Lower Pane View > DLLS / Handles)
            cisvc.exe	cisvc.exe		2,628 K	696 K	744	Content Index service	Microsoft Corporation                               // %systemroot%/system32/ciscv.exe
                cidaemon.exe	cidaemon.exe		3,196 K	320 K	3264	Indexing Service filter daemon	Microsoft Corporation       // %systemroot%/system32/cidaemon.exe

        # procmon
            Filter
                Process Name is Lab11-03.exe Include
                Process Name is cisvc.exe Include
                Operation is WriteFile Include
            Result
                2:50:56.7401048 PM	Lab11-03.exe	2352	WriteFile	C:\WINDOWS\system32\inet_epar32.dll	SUCCESS	Offset: 0, Length: 49,152
                2:50:57.8764914 PM	cisvc.exe	1128	WriteFile	C:\WINDOWS\system32\kernel64x.dll	SUCCESS	Offset: 0, Length: 45                   // key log

        # autoruns
            NULL

        # ApateDNS
            NULL
        
        # sc
            C:\Documents and Settings\practice\Desktop>sc query cisvc

            SERVICE_NAME: cisvc
                    TYPE               : 120  WIN32_SHARE_PROCESS (interactive)
                    STATE              : 4  RUNNING
                                            (STOPPABLE,PAUSABLE,ACCEPTS_SHUTDOWN)
                    WIN32_EXIT_CODE    : 0  (0x0)
                    SERVICE_EXIT_CODE  : 0  (0x0)
                    CHECKPOINT         : 0x0
                    WAIT_HINT          : 0x0

            C:\Documents and Settings\practice\Desktop>sc qc cisvc
            [SC] GetServiceConfig SUCCESS

            SERVICE_NAME: cisvc
                    TYPE               : 120  WIN32_SHARE_PROCESS (interactive)
                    START_TYPE         : 3   DEMAND_START
                    ERROR_CONTROL      : 1   NORMAL
                    BINARY_PATH_NAME   : C:\WINDOWS\system32\cisvc.exe
                    LOAD_ORDER_GROUP   :
                    TAG                : 0
                    DISPLAY_NAME       : Indexing Service
                    DEPENDENCIES       : RPCSS
                    SERVICE_START_NAME : LocalSystem

        # IDA Pro
            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            CopyFileA(ExistingFileName, NewFileName, 0);            // Lab11-03.dll -> C:\WINDOWS\System32\inet_epar32.dll
            sprintf(&FileName, aCWindowsSystem_0, aCisvcExe);       // C:\WINDOWS\System32\cisvc.exe
            sub_401070(&FileName);                                  // Map into memory and modify the data, then unmap(write the modified data into disk)
            system(aNetStartCisvc);                                 // net start cisvc
            return 0;
            }

            Compare ciscv original with the modified ciscv through PEview.
                ciscv.original.exe Address of Entry Point: 129B
                ciscv.modified.exe Address of Entry Point: 1A28

            sub_401070 Line 55, C key on dword_409030
            .data:00409030                 push    ebp
            .data:00409031                 mov     ebp, esp        ; DATA XREF: sub_401070+1ADâ†‘r
            .data:00409031                                         ; sub_401070+1BDâ†‘r
            .data:00409033                 sub     esp, 40h        ; DATA XREF: sub_401070+1CDâ†‘r
            .data:00409039                 jmp     loc_409134       // C:\WINDOWS\system32\inet_epar32.dll zzz69806582

            We need to focus on ciscv modified version.

Lab11-03.dll
    PE Analysis
        # Virustotal
            18/68
            SHA-256: f11fa868ac3dee1e5fbd985fe15ba6d34c7ec0abb47babe0d34a35514c49c86a
            Keylogger.dll

            PEiD packer
                Armadillo v1.xx - v2.xx

            TimeStamp: 2011-11-08 22:33:33

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	23338	24576	6.41	16ebf56a9bcdf27fb053a7c03284ff6e
                .rdata	28672	3229	4096	4.56	a11822595add7422f4814bdce45f0812
                .data	32768	17444	12288	0.76	5fa668968ea5616e9311f18063cd7694
                .reloc	53248	3416	4096	3.43	582497a8079e2542856fba85c6541391

            IMPORT
                KERNEL32.dll
                    GetLastError
                    GetEnvironmentVariableA
                    HeapFree
                    GetStdHandle
                    EnterCriticalSection
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    TlsAlloc
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    DeleteCriticalSection
                    GetCurrentProcess
                    GetEnvironmentStrings
                    GetCPInfo
                    InterlockedDecrement
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCommandLineA
                    GetProcAddress
                    GetStringTypeA
                    OpenMutexA
                    SetStdHandle
                    CreateMutexA
                    GetModuleHandleA
                    CreateThread
                    TlsFree
                    SetFilePointer
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    GetVersion
                    TerminateProcess
                    WideCharToMultiByte
                    InitializeCriticalSection
                    HeapCreate
                    VirtualFree
                    TlsGetValue
                    Sleep
                    GetFileType
                    TlsSetValue
                    CreateFileA
                    HeapAlloc
                    GetCurrentThreadId
                    InterlockedIncrement
                    VirtualAlloc
                    SetLastError
                    LeaveCriticalSection
                USER32.dll
                    GetWindowTextA
                    GetAsyncKeyState                // keylogger?
                    GetForegroundWindow             // keylogger?

            Exports
                zzz69806582

        # strings.exe
            H:mm:ss
            dddd, MMMM dd, yyyy
            M/d/yy
            December
            November
            October
            September
            August
            July
            June
            April
            March
            February
            January
            Dec
            Nov
            Oct
            Sep
            Aug
            Jul
            Jun
            May
            Apr
            Mar
            Feb
            Jan
            Saturday
            Friday
            Thursday
            Wednesday
            Tuesday
            Monday
            Sunday
            Sat
            Fri
            Thu
            Wed
            Tue
            Mon
            Sun
            SunMonTueWedThuFriSat
            JanFebMarAprMayJunJulAugSepOctNovDec
            Sleep
            xV4
            C:\WINDOWS\System32\inet_epar32.dll
            zzz69806582
            .text
            net start cisvc
            C:\WINDOWS\System32\%s
            cisvc.exe
            Lab11-03.dll
            C:\WINDOWS\System32\inet_epar32.dll

    Dynamic Analysis
        # IDA Pro
            BOOL zzz69806582()
            {
            return CreateThread(0, 0, StartAddress, 0, 0, 0) == 0;
            }

            HANDLE __stdcall StartAddress()
            {
            ...
            result = CreateFileA(FileName, 0xC0000000, 1u, 0, 4u, 0x80u, 0);// C:\WINDOWS\System32\kernel64x.dll
            hFile = result;
            if ( result )
            {
            SetFilePointer(result, 0, 0, 2u);
            v8 = hFile;
            sub_10001380(&v3);
            CloseHandle(hFile);
            result = (HANDLE)CloseHandle(hObject);
            }
            ...
            }

            signed int __cdecl sub_10001380(int a1)
            {
            DWORD NumberOfBytesWritten; // [esp+4h] [ebp-404h]
            char Buffer; // [esp+8h] [ebp-400h]

            while ( !sub_10001030(a1) )             // GetAsyncKeyState <- Confirm keylogger here
            {
                if ( *(_DWORD *)a1 )
                {
                sprintf(&Buffer, '%s: %s',0Ah,0, a1 + 4, a1 + 1032);
                WriteFile(*(HANDLE *)(a1 + 2060), &Buffer, strlen(&Buffer), &NumberOfBytesWritten, 0);              // <- Confirm keylogger here
                }
                Sleep(0xAu);
            }
            return 1;
            }

ciscv.exe
    PE Analysis
        # Virustotal
            9/68
            SHA-256: 8b0636fcbc4aad596d1794b7b501eee2c07a2a8c43106f81fab24904f255fe56

        # strings.exe
            C:\WINDOWS\System32\inet_epar32.dll
            zzz69806582
         
    Dynamic Analysis
        OllyDbg

        01001B0A  |.  FF55 FC       CALL DWORD PTR SS:[EBP-4]                ; kernel32.LoadLibraryExA
        Stack
        0007FF74  [01001B31  1   ; |FileName = "C:\WINDOWS\System32\inet_epar32.dll"
        0007FF78   00000000        ; |hFile = NULL
        0007FF7C   00000000        ; \Flags = 0

        # LoadLibraryA("C:\WINDOWS\System32\inet_epar32.dll", NULL, 0)

        01001B1B  |.  FF55 F4       CALL DWORD PTR SS:[EBP-0C]               ; kernel32.GetProcAddress
        Stack
        0007FF78  /10000000       ; |hModule = 10000000 ('inet_epar32')
        0007FF7C  |01001B55  U   ; \Procname = "zzz69806582"

        # GetProcAddress("zzz69806582", hModule_of_inet_epar32)

        01001B21  |.  FF55 F8       CALL DWORD PTR SS:[EBP-8]                ; inet_epar32.zzz69806582

        goto check zzz69806582() in Lab11-03.dll

Analysis
    First we can know that Lab11-03.exe modify the original ciscv.exe in the system. Then we use OllyDbg to analyze the new ciscv.exe and get that it load and aquire the handle of Lab11-03.dll, then call the zzz69806582() export function in it. At last we know the zzz69806582() write key log into file kernel64x.dll.
    