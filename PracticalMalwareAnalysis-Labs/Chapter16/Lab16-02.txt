Lab16-02.exe
    PE Analysis
        # Virustotal
            20/68
            SHA-256: 0c3031f630adc6cdd7b877fa1c2982909cde01dff612db5dd7df58cc778dd919

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2011-11-03 04:19:52

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .tls	4096	621	4096	1.25	c97001d46d25f5254e8ed7d786361326
                .text	8192	18680	20480	6.29	215cd8ea9cfa53421de38b4c43ef832a
                .rdata	28672	2348	4096	3.64	b097c00c34e7c65239d886202b31faa5
                .data	32768	16060	12288	0.6	8e097cd9a4fa3262ea9d8b062d50fb93

            IMPORT
                KERNEL32.dll
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetOEMCP
                    LCMapStringA
                    HeapDestroy
                    ExitProcess
                    FlushFileBuffers
                    GetEnvironmentStringsW
                    GetVersionExA
                    GetModuleFileNameA
                    RtlUnwind
                    LoadLibraryA
                    FreeEnvironmentStringsA
                    GetCurrentProcess
                    GetEnvironmentStrings
                    WideCharToMultiByte
                    UnhandledExceptionFilter
                    MultiByteToWideChar
                    FreeEnvironmentStringsW
                    GetCPInfo
                    GetCommandLineA
                    GetProcAddress
                    SetStdHandle
                    SetFilePointer
                    CreateThread
                    GetStringTypeA
                    GetModuleHandleA
                    WriteFile
                    GetStartupInfoA
                    CloseHandle
                    GetACP
                    HeapReAlloc
                    GetStringTypeW
                    GetVersion
                    TerminateProcess
                    GetEnvironmentVariableA
                    HeapCreate
                    VirtualFree
                    Sleep
                    GetFileType
                    HeapAlloc
                    OutputDebugStringA
                    VirtualAlloc
                    SetLastError
                USER32.dll
                    FindWindowA

        # strings.exe (Only part of the results)
            $D@
            w,@
            p@ss
            OLLYDBG
            Incorrect password, Try again.
            You entered the correct password!
            usage: %s <4 character password>

    Dynamic Analysis
        C:\Documents and Settings\practice\Desktop>Lab16-02.exe
        usage: Lab16-02.exe <4 character password>

        C:\Documents and Settings\practice\Desktop>Lab16-02.exe test
        Incorrect password, Try again.

        C:\Documents and Settings\practice\Desktop>Lab16-02.exe byrr
        You entered the correct password!

        # IDA Pro & OllyDbg
            Ctrl+E          (check the entry point)
                TlsCallback_0	00401060
                start	00402179	[main entry]

            void __stdcall TlsCallback_0(int a1, int a2, int a3)
            {
            if ( a2 == 1 && FindWindowA('OLLYDBG', 0) )
                exit(0);
            if ( a2 == 2 )
                sub_401020();
            }

            DWORD sub_401020()
            {
            SetLastError(12345u);
            OutputDebugStringA('b');                // send 'b' to debugger to check
            result = GetLastError();                // If debugger exists, error returned
            if ( result == 12345 )
                ++byte_40A968;                      // Modify by NOP in 0x401051
            return result;
            }

            int __cdecl main(int argc, const char **argv, const char **envp)
            {
            int result; // eax
            DWORD ThreadId; // [esp+0h] [ebp-8h]
            int v5; // [esp+4h] [ebp-4h]

            v5 = 1;
            if ( argc == 1 )
            {
                printf(aUsageS4Charact, *argv);             // usage: %s <4 character password>
                result = 0;
            }
            else
            {
                CreateThread(0, 0, StartAddress, 0, 0, &ThreadId);
                Sleep(1000u);
                v5 = strncmp(argv[1], &encoded_password, 4u);
                if ( v5 )
                printf(aIncorrectPassw);
                else
                printf(aYouEnteredTheC);
                result = 0;
            }
            return result;
            }

            .data:00408030 encoded_password db 'P'                 ; DATA XREF: StartAddress+22↑w
            .data:00408030                                         ; StartAddress+60↑w ..                   // Maybe decoded in StartAddress

            StartAddress
            .tls:0040112B                 mov     ebx, large fs:30h
            .tls:0040118B                 mov     bl, [ebx+2]               // BeingDebugged

            Phantom > Hide OllyDbg Window, Load Driver (TLS), Hide from PEB
            modify NOP in 0x401051 and call Sleep (0x401221)
            F2 strncmp (0x40123A)                                   // byrr
