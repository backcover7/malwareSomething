Lab16-01.exe
    PE Analysis
        # Virustotal
            40/73
            SHA-256: 309217d8088871e09a7a03ee68ee46f60583a73945006f95021ec85fc1ec959e

            PEiD packer
                Microsoft Visual C++

            TimeStamp: 2011-10-20 16:42:33

            Subsystem: Windows CUI
            
            Sections
                Name	Virtual Address	Virtual Size	Raw Size	Entropy	MD5
                .text	4096	40472	40960	6.54	6c00918cad6d46eaaf41cf6b524f7b5b
                .rdata	45056	3440	4096	4.82	3f4d5e4ca81bfa58a315a2313fbd0f06
                .data	49152	16828	12288	0.81	536b12027ac7bd99cb471588df26c858

            IMPORT
                ADVAPI32.dll
                    CloseServiceHandle
                    OpenServiceA
                    CreateServiceA
                    RegQueryValueExA
                    ChangeServiceConfigA
                    RegSetValueExA                  // RegSetValue
                    RegDeleteValueA
                    RegCreateKeyExA
                    DeleteService
                    RegOpenKeyExA
                    OpenSCManagerA                  // service
                KERNEL32.dll
                    GetSystemTime
                    GetLastError
                    HeapFree
                    GetStdHandle
                    LCMapStringW
                    SetHandleCount
                    GetFileAttributesA
                    WaitForSingleObject
                    GetExitCodeProcess
                    LCMapStringA
                SHELL32.dll
                    ShellExecuteA
                WS2_32.dll
                    socket
                    recv
                    send
                    WSACleanup
                    WSAStartup
                    gethostbyname
                    connect
                    shutdown
                    htons
                    closesocket

        # strings.exe (Only part of the results)
            cmd.exe
            >> NUL
            /c del
            Configuration
            SOFTWARE\Microsoft \XPS
            \kernel32.dll
            HTTP/1.0
            GET
            '`'`'
            `'`'`
            NOTHING
            CMD
            DOWNLOAD
            UPLOAD
            SLEEP
            ups
            http://www.practicalmalwareanalysis.com
            Manager Service
            .exe
            %SYSTEMROOT%\system32\
            k:%s h:%s p:%s per:%s

    Dynamic Analysis
        Similar as Lab09-01.exe

        # IDA Pro & OllyDbg
            .text:00403554                 mov     eax, large fs:30h            // fs:30h points to PEB structure
            .text:0040355A                 mov     bl, [eax+2]                  // BeingDebugged
            .text:0040355D                 mov     [ebp+var_1820], bl
            .text:00403563                 movsx   eax, [ebp+var_1820]
            .text:0040356A                 test    eax, eax                     // Check if BeingDebugged is 0 <- 0 means no debugger

            .text:00403579                 mov     eax, [eax+18h]               // ProcessHeap in PEB (offset 0x18)
            .text:0040357C                 db      3Eh
            .text:0040357C                 mov     eax, [eax+10h]               // The 0x10(XP) / 0x44(Win7) offset attr in the first heap in PEB       ;ForceFlags attribute
                                                                                // Or check 0xC(XP) / 0x40(Win7) offset attr: Flags

            .text:00403594                 mov     eax, large fs:30h
            .text:0040359A                 db      3Eh
            .text:0040359A                 mov     eax, [eax+68h]               // NTGlobalFlag
            .text:0040359E                 sub     eax, 70h                     // If it is 0x70, there is debugger
            .text:004035A1                 mov     [ebp+var_1828], eax
            .text:004035A7                 cmp     [ebp+var_1828], 0

            OllyDbg > Plugins >
                > Command Line
                    dump fs:[30] + 2                // BeingDebugged
                    Binary > Fill with 00's

                    dump ds:[fs:[30] + 0x18] + 0x10 // ProcessHeap
                    Binary > Fill with 00's

                    dump fs:[30] + 0x68             // NTGlobalFlag
                    Binary > Fill with 00's

            WinDbg.exe -hd Lab16-01.exe     // ProcessHeap


                > Phantom
                    Hide from PEB
                    reload the Malware
